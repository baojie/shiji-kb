# 史记知识库 - TODO 列表

## 🚀 功能建议

### 高优先级

- [x] **PN (Purple Numbers) 可点击复制功能** ✅
  - 每个段落编号都是可点击的锚点链接
  - 点击 PN 自动复制带锚点的完整 URL 到剪贴板
  - 复制成功后显示 ✓ 提示
  - 便于精确引用和分享特定段落
  - 实现了 Doug Engelbart 的 Purple Numbers 理念

- [x] **实体交叉引用跳转** ✅ 2026-02-09
  - 正文中所有实体已添加 `<a>` 链接，点击跳转到实体索引页对应条目
  - 实体索引条目中列出所有章节段落引用，点击可跳回原文段落
  - 别名→规范名映射：正文中的"沛公"链接到索引中的"刘邦"条目

- [x] **章节间交叉引用** ✅ 2026-02-09（通过实体索引实现）
  - 11类实体索引页面，按拼音排序，含字母导航和搜索过滤
  - 每个实体条目列出所有章节中的出现位置（段落级精度）
  - 别名合并机制（entity_aliases.json，~570条人名canonical条目）

- [x] **实体别名合并与语义消歧** ✅ 2026-02-10
  - 同人别名合并19组：帝号统一、人名↔谥号、封号变体等
  - 语义消歧1,281处：歧义短名（昭王/惠王/文公等）→带国名全称
  - `disambiguate_names.py`：4层启发式消歧（共现全名 > 附近国名 > 前置国名 > 章节主题国）
  - 时代矛盾检测修正11处错误，138处不确定案例保守跳过

### 中优先级

- [ ] **实体悬停预览**
  - 鼠标悬停在实体上时，显示该实体在本文中的其他出现位置
  - 在 tooltip 中显示跳转链接到其他段落
  - 示例：鼠标移到"舜"上，显示"本文中其他出现：段落 1.2, 3.4, 5.6..."

- [ ] **实体详情面板**
  - 点击实体后，在侧边栏显示详细信息
  - 包含：所有出现位置、相关实体、时间线等

- [ ] **搜索功能**
  - 全文搜索
  - 按实体类型筛选
  - 按章节筛选

- [ ] 亲属关系变成游戏 the roottrees are dead

### 低优先级

- [ ] **时间线可视化**
  - 将标注的时间信息可视化
  - 显示历史事件的时间顺序

- [ ] **关系图谱**
  - 人物关系图
  - 地理位置图
  - 事件关联图

- [ ] **注释系统**
  - 用户可以添加个人注释
  - 支持导出/导入注释

## 🐛 Bug 修复

- [x] 列表在 NOTE 块中渲染为段落而非列表项
- [x] 列表项间距过大
- [x] HTML 文件中包含绝对路径

## 🎨 样式优化

- [x] 去除列表项目符号
- [x] 调整列表缩进为 2em
- [ ] 响应式设计优化（移动端）
- [ ] 暗色主题支持
- [ ] 字体大小可调节

## 📝 内容相关

- [x] **十表（013-022）表格渲染** ✅ 2026-02-09
  - 十篇年表全部嵌入Markdown并渲染为HTML（全视口宽度、sticky表头、实体标注）
  - 016秦楚之际月表按原始数据拆分为两表（秦二世时期 / 项羽分封后）
  - 修复015/017/018/019表头缺失、021/022句号等问题
- [ ] **年表加三家注**（裴骃《集解》、司马贞《索隐》、张守节《正义》）
  - 从 015_六国年表 开始，逐步覆盖其他表章（013-022）
  - 需确定注释在表格HTML中的呈现方式（行内展开 / tooltip / 侧栏等）
- [ ] **与中华书局版电子版校对**
  - 对照中华书局点校本，核查正文文字差异
  - 优先校对年表章节（013-022）
- [ ] 完成更多章节的标注
- [ ] 统一实体标注规范
- [ ] 添加段落注释和解释
- [ ] 完成史记和可选的古籍后，实验无版权小说（如福尔摩斯探案集）

## 🔧 技术改进

- [x] 将实体数据提取为 JSON 格式 ✅ entity_index.json
- [ ] 使用数据库存储实体信息
- [ ] 添加自动化测试
- [ ] 优化构建流程
- [ ] 添加 CI/CD 自动部署

## 📚 文档

- [x] GitHub Pages 配置指南
- [x] 发布脚本使用说明
- [ ] 标注规范文档
- [ ] 开发者指南
- [ ] API 文档（如果有后端）

## 💡 实现记录：实体交叉引用

### 已实现方案：构建时生成索引 + 静态索引页面

采用方案2（构建时生成索引），实现为静态HTML索引页面：

- `build_entity_index.py`：扫描130篇tagged.md，提取实体，生成 `entity_index.json` 和 `docs/entities/*.html`
- `render_shiji_html.py`：在生成章节HTML时，为每个实体包裹 `<a>` 链接，跳转到对应索引页条目
- `entity_aliases.json`：别名合并配置，支持"沛公"→"刘邦"等映射
- `docs/js/entity-filter.js`：客户端搜索过滤
- `docs/css/entity-index.css`：索引页面样式

### 未来可选增强：页内悬停预览

可在此基础上添加纯前端tooltip，在正文中悬停实体时显示本页内其他出现位置

## 💡 实现记录：语义消歧

### 问题

史记原文中大量使用短名指代人物（"昭王""惠公""文公"等），同一短名在不同章节指不同的人：

- "昭王"可能是秦昭王、燕昭王、楚昭王
- "惠王"可能是秦惠王、魏惠王、燕惠王、韩惠王
- "文公"可能是晋文公、秦文公、鲁文公、郑文公

### 方案：`disambiguate_names.py`

4层启发式消歧策略（优先级从高到低）：

1. **共现全名**（cooccur）：同一章节中已有`@秦昭王@`出现，则该章的`@昭王@`→`@秦昭王@`
2. **附近国名**（nearby_state）：`@昭王@`前后80字内出现`&秦&`或`@秦X@`，则→`@秦昭王@`
3. **前置国名**（preceding_state）：`&秦&@昭王@`模式直接匹配
4. **章节主题国**（chapter_state）：秦本纪中的`@昭王@`默认→`@秦昭王@`

### 安全机制

- **跳过已有全名**：`@齐桓公@`、`@秦昭王@`等不处理
- **共现冲突检测**：同章有`@楚怀王@`时，不将`@怀王@`映射到`@梁怀王@`
- **时代矛盾检测**：后处理检查，发现周襄王时期出现秦昭襄王等时序错误并修正
- **保守策略**：无法确定的138处（如太后、梁王等）保留原短名不处理

### 统计

| 短名 | 消歧前 | 消歧后 | 新增全名条目 |
| ---- | ------ | ------ | ----------- |
| 武王 | 133 | 27 | 周武王(84), 秦武王(30) |
| 昭王 | 96 | 9 | 秦昭王(+62), 燕昭王(+5), 楚昭王(+10) |
| 惠王 | 77 | 19 | 秦惠王(+25), 魏惠王(+5), 燕惠王(+9), 周惠王(+11) |
| 景公 | 77 | ~0 | 齐景公(+45), 晋景公(+20) |
| 孝公 | 52 | 1 | 秦孝公(+40) |
| 文公 | 47 | 1 | 晋文公(+10) 等 |
| 缪公 | 62 | 0 | 秦缪公(+62) |
| 怀王 | 41 | ~0 | 楚怀王(+41) |

---

**最后更新**: 2026-02-10
