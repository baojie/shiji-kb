# 《史记》101-130章节批量处理指南

## 概述

本指南说明如何批量处理《史记》的101-130章节（最后30个列传），包括：
- 袁盎晁错列传、张释之冯唐列传等人物列传
- 匈奴列传、南越列传等民族列传
- 循吏列传、酷吏列传等类传
- **太史公自序**（第130章，非常重要！）

## 已完成

✅ **处理脚本**: `/home/baojie/work/shiji-kb/scripts/process_chapters_101_130.py`
✅ **示例章节**: `/home/baojie/work/shiji-kb/chapter_md/101_袁盎晁错列传.tagged.md`

## 使用方法

### 方法一：使用Python脚本批量处理（推荐）

#### 1. 设置API密钥

```bash
# 设置Anthropic API密钥（请替换为你的实际密钥）
export ANTHROPIC_API_KEY="your_api_key_here"
```

#### 2. 运行处理脚本

```bash
cd /home/baojie/work/shiji-kb
python3 scripts/process_chapters_101_130.py
```

#### 3. 脚本功能

- 自动处理所有30个章节
- 对每个章节进行实体标注（人名、地名、官职、族群等）
- 生成结构化的Markdown文件
- 显示处理进度和统计信息
- 文件已存在时会提示是否覆盖

#### 4. 输出目录

处理后的文件将保存在：`/home/baojie/work/shiji-kb/chapter_md/`

文件命名格式：`XXX_章节名.tagged.md`

### 方法二：分批处理（如果遇到问题）

如果一次处理30个章节遇到问题，可以分批处理：

#### 第一批：101-110（10个列传）

```python
# 修改 scripts/process_chapters_101_130.py 中的 CHAPTERS 列表
CHAPTERS = [
    "101_袁盎晁错列传",
    "102_张释之冯唐列传",
    "103_万石张叔列传",
    "104_田叔列传",
    "105_扁鹊仓公列传",
    "106_吴王濞列传",
    "107_魏其武安侯列传",
    "108_韩长孺列传",
    "109_李将军列传",
    "110_匈奴列传",
]
```

#### 第二批：111-120（10个列传）

```python
CHAPTERS = [
    "111_卫将军骠骑列传",
    "112_平津侯主父列传",
    "113_南越列传",
    "114_东越列传",
    "115_朝鲜列传",
    "116_西南夷列传",
    "117_司马相如列传",
    "118_淮南衡山列传",
    "119_循吏列传",
    "120_汲郑列传",
]
```

#### 第三批：121-130（10个列传，含太史公自序）

```python
CHAPTERS = [
    "121_儒林列传",
    "122_酷吏列传",
    "123_大宛列传",
    "124_游侠列传",
    "125_佞幸列传",
    "126_滑稽列传",
    "127_日者列传",
    "128_龟策列传",
    "129_货殖列传",
    "130_太史公自序",  # ⭐⭐⭐ 最重要！
]
```

## 处理规则

### 实体标注

- **人名**: `@人名@`（如：@袁盎@、@晁错@、@李广@、@司马迁@）
- **地名**: `=地名=`（如：=长安=、=匈奴=）
- **官职**: `$官职$`（如：$丞相$、$御史大夫$）
- **时间**: `%时间%`（如：%孝文帝六年%）
- **朝代**: `&朝代&`（如：&汉&、&秦&）
- **族群**: `~族群~`（如：~匈奴~、~月氏~、~乌孙~）⭐ 民族列传大量使用
- **制度**: `^制度^`（如：^刑名^、^尚书^）
- **器物**: `*器物*`（如：*和氏璧*、*朝衣*）
- **神话**: `?神话?`（如：?人彘?）
- **动植物**: `🌿动植物🌿`

### 文档结构

```markdown
# [0] 列传名

## 人物名/主题

### 具体事件

[1.1] 第一段内容...

[1.2] 第二段内容...

### 对话处理

[2.1] @人名@曰：

> NOTE: 对话说明（长对话时使用）
> "对话内容..."
```

## 特殊章节注意事项

### 110_匈奴列传 ⭐⭐

- 内容较长，包含匈奴历史、风俗、与汉朝的战争
- 大量使用 `~族群~` 标注（~匈奴~、~月氏~、~乌孙~等）
- 按历史时期划分二级标题

### 111_卫将军骠骑列传 ⭐⭐

- 卫青、霍去病的事迹
- 重要军事人物，战功显赫

### 113-116_边疆民族列传

- 南越列传、东越列传、朝鲜列传、西南夷列传
- 边疆民族志，需标注族群和地名
- 按历史沿革和重大事件划分

### 117_司马相如列传 ⭐⭐

- 包含《子虚赋》、《上林赋》等文学作品
- 长赋需要保持完整性，适当分段

### 119-129_类传

- 循吏列传、酷吏列传、游侠列传、佞幸列传、滑稽列传、日者列传、货殖列传
- 按人物类型归纳
- 每个人物设立独立的二级或三级标题
- 如有总论，置于最前；太史公曰置于最后

### 130_太史公自序 ⭐⭐⭐⭐⭐

**《史记》最重要的章节之一！**

#### 内容包括：

1. **司马氏家世**
   - 历代祖先：@司马错@、@司马昌@、@司马靳@、@司马谈@等
   - 需要详细标注每一代人物

2. **司马迁生平**
   - 早年游历
   - 继承父职（@司马谈@）
   - **李陵之祸**（非常重要！司马迁受宫刑）
   - 发愤著书

3. **《史记》著述说明**
   - 史记体例（本纪、表、书、世家、列传）
   - 130篇目录总序
   - 著述宗旨和史学思想

4. **处理要求**
   - 需要**非常细致**地处理
   - 每个细节都要准确标注
   - 这是了解司马迁和《史记》的关键

## 质量检查

处理完成后，请检查：

1. ✅ 所有实体都正确标注
2. ✅ 段落编号连续（[1.1], [1.2], ...）
3. ✅ 标题层级正确（一级、二级、三级）
4. ✅ 对话使用引用块（> 符号）
5. ✅ 长对话有 NOTE 说明
6. ✅ 原文完整无遗漏
7. ✅ 特殊符号正确（@、=、$、%、&、^、~、*、?、🌿）

## 验证脚本

```bash
# 使用验证脚本检查标注质量
cd /home/baojie/work/shiji-kb
python3 scripts/validate_tagging.py chapter_md/101_袁盎晁错列传.tagged.md
```

## 统计信息

成功处理一个章节后，脚本会显示：

```
✅ 处理完成
   - 行数: 250
   - 人名标注: 45
   - 地名标注: 28
   - 族群标注: 15  # 民族列传会很多
   - Token使用: 3500 in / 12000 out
```

## 预计时间

- 单个章节：2-5分钟
- 全部30个章节：1-2.5小时（取决于网络和API响应速度）
- 匈奴列传、司马相如列传等长篇可能需要更长时间

## 故障排查

### 问题1：API密钥错误

```
❌ 错误: 未设置 ANTHROPIC_API_KEY 环境变量
```

**解决**: 设置环境变量

```bash
export ANTHROPIC_API_KEY="your_api_key_here"
```

### 问题2：网络连接问题

**解决**: 检查网络连接，可能需要代理

```bash
export https_proxy=http://your_proxy:port
```

### 问题3：Token不足

**解决**:
- 检查API账户余额
- 或者分批处理（见"方法二：分批处理"）

### 问题4：文件已存在

脚本会提示：
```
⚠️  文件已存在: 101_袁盎晁错列传.tagged.md
   是否覆盖? (y/n):
```

输入 `y` 覆盖，或 `n` 跳过

## 完成后

处理完成后，你将拥有：

1. ✅ 30个结构化的Markdown文件
2. ✅ 完整的实体标注
3. ✅ 《史记》101-130章节的数字化版本
4. ✅ 可用于知识图谱、语义搜索等应用

## 参考

- 已完成示例：`chapter_md/101_袁盎晁错列传.tagged.md`
- 之前的处理：`chapter_md/001_五帝本纪.tagged.md` - `chapter_md/010_孝文本纪.tagged.md`
- 处理脚本：`scripts/process_chapters_101_130.py`

---

**祝处理顺利！** 如有问题，请参考已完成的示例文件。
