# 批量处理《史记》111-130列传章节

## 快速开始

### 准备工作

1. **设置API密钥**（必需）
   ```bash
   export ANTHROPIC_API_KEY='你的API密钥'
   ```

   或者保存到文件：
   ```bash
   echo '你的API密钥' > ~/.anthropic_key
   chmod 600 ~/.anthropic_key
   ```

2. **检查当前状态**
   ```bash
   ./scripts/check_111_130_status.sh
   ```

### 开始处理

```bash
# 方法1: 使用便捷脚本
./scripts/run_111_130.sh

# 方法2: 直接运行Python脚本
python3 scripts/process_chapters_111_130.py
```

## 章节列表（共20个）

```
111_卫将军骠骑列传        - 卫青、霍去病传记
112_平津侯主父列传        - 汉武帝时期大臣
113_南越列传              - 南越国历史（民族列传）
114_东越列传              - 东越国历史（民族列传）
115_朝鲜列传              - 朝鲜历史（民族列传）
116_西南夷列传            - 西南民族（民族列传）
117_司马相如列传          - 辞赋家（含《子虚赋》《上林赋》）
118_淮南衡山列传          - 淮南王、衡山王
119_循吏列传              - 良吏事迹（类传）
120_汲郑列传              - 汲黯、郑当时
121_儒林列传              - 儒学传承（类传）
122_酷吏列传              - 严刑执法者（类传）
123_大宛列传              - 西域大宛国（民族列传）
124_游侠列传              - 游侠人物（类传）
125_佞幸列传              - 宠臣（类传）
126_滑稽列传              - 滑稽人物（类传）
127_日者列传              - 占卜者（类传）
128_龟策列传              - 龟卜（类传）
129_货殖列传              - 商人（类传）
130_太史公自序 ⭐⭐⭐     - 司马迁自述（最重要！）
```

## 特别说明

### 130_太史公自序（最重要的一章）

这是《史记》最重要的篇章之一，包含：

1. **司马氏家世** - 司马错、司马昌、司马靳、司马谈等祖先
2. **司马迁生平** - 早年游历、继承父职、李陵之祸、发愤著书
3. **《史记》体例** - 本纪、表、书、世家、列传的说明
4. **130篇总序** - 每一篇的创作缘起
5. **著述宗旨** - "究天人之际，通古今之变，成一家之言"

**处理要求**：需要最细致的标注，特别是：
- 每一位司马氏祖先的人名、官职
- 司马迁生平的时间节点
- 李陵之祸的详细人物、时间、事件
- 130篇的完整目录

## 标注规则（11类实体）

| 实体类型 | 标注格式 | 示例 |
|---------|---------|------|
| 人名 | `@人名@` | @卫青@、@霍去病@、@司马迁@ |
| 地名 | `=地名=` | =长安=、=茂陵=、=河西= |
| 官职 | `$官职$` | $大将军$、$骠骑将军$、$太史令$ |
| 时间/纪年 | `%时间%` | %元光五年%、%元狩四年% |
| 朝代/国号 | `&朝代&` | &汉&、&秦&、&楚& |
| 制度/典章 | `^制度^` | ^封禅^、^太初历^ |
| 族群/部落 | `~族群~` | ~匈奴~、~南越~、~东越~、~大宛~ |
| 器物/礼器 | `*器物*` | *金人*、*玉玺* |
| 天文/历法 | `!天文!` | !太初历!、!北斗! |
| 传说/神话 | `?神话?` | ?封狼居胥? |
| 动植物 | `🌿动植物🌿` | 🌿马🌿、🌿羊🌿 |

## 处理特点

### 自动化功能
- ✅ 断点续传（自动保存进度）
- ✅ 智能跳过已完成章节
- ✅ 详细处理统计
- ✅ 错误记录与重试

### 输出位置
```
输入: /home/baojie/work/shiji-kb/docs/original_text/[章节].txt
输出: /home/baojie/work/shiji-kb/chapter_md/[章节].tagged.md
进度: /home/baojie/work/shiji-kb/progress_111_130.json
```

### 处理统计
每个章节处理后会显示：
- 行数
- 人名标注数
- 地名标注数
- 族群标注数
- 官职标注数
- Token使用量

## 预期情况

### 时间预估
- 单个章节：1-3分钟
- 全部20个章节：30-60分钟

### Token消耗
- 预计总消耗：50-100万 tokens
- 使用模型：claude-sonnet-4-20250514

### 文件大小
- 每个章节：10-50KB
- 总计：约200KB-1MB

## 验证结果

### 检查生成文件
```bash
ls -lh chapter_md/1[12]*.tagged.md
```

### 统计标注数量
```bash
# 统计人名标注
grep -o '@[^@]*@' chapter_md/111_卫将军骠骑列传.tagged.md | wc -l

# 统计地名标注
grep -o '=[^=]*=' chapter_md/111_卫将军骠骑列传.tagged.md | wc -l

# 统计族群标注
grep -o '~[^~]*~' chapter_md/113_南越列传.tagged.md | wc -l
```

### 查看进度
```bash
cat progress_111_130.json | jq .
```

## 后续处理

处理完成后可以：

1. **生成HTML版本**
   ```bash
   python3 render_shiji_html.py
   ```

2. **验证标注质量**
   ```bash
   python3 scripts/validate_all_chapters.py
   ```

3. **提取实体关系**
   ```bash
   python3 extract_all_relations.py
   ```

## 问题排查

### API密钥未设置
```
错误: 未设置 ANTHROPIC_API_KEY 环境变量
```
**解决**：按照"准备工作"部分设置API密钥

### Token超限
```
处理失败: Token limit exceeded
```
**解决**：等待一段时间后重试

### 网络问题
```
处理失败: Connection error
```
**解决**：检查网络连接，重新运行（会自动从断点继续）

## 文档

详细文档：`scripts/README_111_130.md`

## 核心文件

```
scripts/
├── process_chapters_111_130.py      # 主处理脚本
├── run_111_130.sh                   # 便捷运行脚本
├── check_111_130_status.sh          # 状态检查脚本
└── README_111_130.md                # 详细文档
```

## 开始处理吧！

```bash
# 1. 设置API密钥
export ANTHROPIC_API_KEY='your-api-key-here'

# 2. 运行处理
./scripts/run_111_130.sh

# 3. 等待完成（30-60分钟）

# 4. 验证结果
ls -lh chapter_md/1[12]*.tagged.md
```

---

**重要提示**：130_太史公自序是《史记》最重要的篇章，需要特别关注处理质量！
