# 《史记》096-110列传批量标注使用说明

## 任务概述

批量处理《史记》096-110共15个列传章节，进行结构化标注和实体识别。

## 章节列表

| 序号 | 章节编号 | 章节名称 | 特点 |
|------|----------|----------|------|
| 1 | 096 | 张丞相列传 | 合传（多位丞相） |
| 2 | 097 | 郦生陆贾列传 | 双人合传 |
| 3 | 098 | 傅靳蒯成列传 | 多人合传 |
| 4 | 099 | 刘敬叔孙通列传 | 双人合传 |
| 5 | 100 | 季布栾布列传 | 双人合传 |
| 6 | 101 | 袁盎晁错列传 | 双人合传 |
| 7 | 102 | 张释之冯唐列传 | 双人合传 |
| 8 | 103 | 万石张叔列传 | 双人合传 |
| 9 | 104 | 田叔列传 | 单人列传 |
| 10 | 105 | 扁鹊仓公列传 | 医学列传 |
| 11 | 106 | 吴王濞列传 | 单人列传 |
| 12 | 107 | 魏其武安侯列传 | 双人合传 |
| 13 | 108 | 韩长孺列传 | 单人列传 |
| 14 | 109 | 李将军列传 | 单人列传（李广） |
| 15 | 110 | 匈奴列传 | 民族列传⭐ |

## 标注规则（11类实体）

| 实体类型 | 标注格式 | 示例 |
|----------|----------|------|
| 人名 | @人名@ | @张苍@、@周昌@、@李广@ |
| 地名 | =地名= | =长安=、=咸阳=、=阳武= |
| 官职 | $官职$ | $丞相$、$御史大夫$、$太守$ |
| 时间/纪年 | %时间% | %秦时%、%汉王四年% |
| 朝代/氏族 | &朝代& | &秦&、&汉&、&楚& |
| 制度/典章 | ^制度^ | ^律历^、^五德^、^封建制^ |
| 族群/部落 | ~族群~ | ~匈奴~、~乌孙~、~月氏~ |
| 器物/礼器 | *器物* | *印绶*、*剑*、*鼎* |
| 天文/历法 | !天文! | !黄龙!、!五星聚! |
| 传说/神话 | ?神话? | ?黄帝?、?女娲? |
| 动植物 | 🌿动植物🌿 | 🌿马🌿、🌿松🌿 |

## 使用方法

### 方法一：命令行运行（推荐）

```bash
# 1. 确保已安装anthropic库
pip install anthropic

# 2. 设置API密钥
export ANTHROPIC_API_KEY="your_api_key_here"

# 3. 运行批处理脚本
python3 /home/baojie/work/shiji-kb/process_096_110_manual.py
```

### 方法二：Python代码调用

```python
import os
os.environ['ANTHROPIC_API_KEY'] = "your_api_key_here"

# 运行脚本
exec(open('/home/baojie/work/shiji-kb/process_096_110_manual.py').read())
```

## 脚本功能特点

### 1. 断点续传
- 处理进度自动保存到 `progress_096_110.json`
- 支持中断后继续处理
- 自动跳过已完成的章节

### 2. 错误处理
- 详细的错误日志
- 失败章节记录
- 可重试失败的章节

### 3. 进度显示
- 实时显示处理进度
- 统计标注实体数量
- Token使用情况

## 输出格式示例

```markdown
# [0] 张丞相列传

## 张丞相苍

### 家世与早年

[1.1] $丞相$@张苍@者，=阳武=人也。好书^律历^。

[1.2] &秦&时为$御史$，主柱下方书。有罪，亡归。

### 从汉立功

[2.1] 及@沛公@略地过=阳武=，@苍@以客从攻=南阳=。

[2.2] @苍@坐法当斩，解衣伏质，身长大，肥白如瓠，时@王陵@见而怪其美士，乃言@沛公@，赦勿斩。

## 周昌

### 家世与早年

[3.1] @周昌@者，=沛=人也。
```

## 特殊章节注意事项

### 110_匈奴列传（最复杂）

这是最重要且最复杂的一章，需要特别注意：

1. **族群标注**：大量~族群~标注
   - ~匈奴~、~乌孙~、~月氏~、~东胡~、~楼烦~、~林胡~

2. **单于世系**：
   - @冒顿单于@、@老上单于@、@军臣单于@

3. **历史沿革**：
   - 从夏商周到汉武帝时期的完整历史

4. **风俗记载**：
   - 单独设立小节

5. **重大战役**：
   - 白登之围、马邑之谋、河南之战等

### 105_扁鹊仓公列传（医学专篇）

1. **医案格式**：每个医案独立标注
2. **病名保留**：原文病名完整保留
3. **诊断过程**：脉诊、望诊完整记录

## 质量检查

处理完成后，建议进行以下检查：

### 1. 自动检查
```bash
# 验证标注格式
python3 scripts/validate_all_chapters.py
```

### 2. 人工抽查
- 检查段落编号是否连续
- 检查实体标注是否完整
- 检查对话格式是否正确

### 3. 统计检查
```bash
# 统计各章节实体数量
for file in chapter_md/09[6-9]_*.tagged.md chapter_md/1[0-1]0_*.tagged.md; do
    echo "=== $(basename $file) ==="
    echo "人名: $(grep -o '@[^@]*@' $file | wc -l)"
    echo "地名: $(grep -o '=[^=]*=' $file | wc -l)"
    echo "官职: $(grep -o '\$[^$]*\$' $file | wc -l)"
    echo ""
done
```

## 预期输出

### 文件位置
- 输入: `/home/baojie/work/shiji-kb/docs/original_text/096_*.txt` 至 `110_*.txt`
- 输出: `/home/baojie/work/shiji-kb/chapter_md/096_*.tagged.md` 至 `110_*.tagged.md`

### 预期规模
每个章节预计：
- 行数: 200-800行
- 人名标注: 50-200个
- 地名标注: 30-100个
- 官职标注: 20-80个
- 族群标注（110章）: 100+个

## 常见问题

### Q1: API认证失败
**A**: 检查环境变量是否正确设置
```bash
echo $ANTHROPIC_API_KEY
```

### Q2: 处理中断
**A**: 直接重新运行脚本，会自动跳过已完成的章节

### Q3: 输出格式不正确
**A**: 检查SYSTEM_PROMPT中的格式要求，可能需要调整

### Q4: Token超限
**A**: 某些章节较长（如110_匈奴列传），可能需要调整max_tokens参数

## 估算时间

- 每章处理时间: 2-5分钟
- 总计（15章）: 30-75分钟
- 实际时间可能因网络和API响应速度而异

## 完成后的验证

```bash
# 检查所有文件是否生成
ls -lh chapter_md/{096..110}_*.tagged.md

# 统计总体情况
wc -l chapter_md/{096..110}_*.tagged.md
```

## 联系与支持

如遇到问题，请检查：
1. `progress_096_110.json` 查看进度
2. 终端输出的错误信息
3. 网络连接和API状态

---

**祝处理顺利！**
