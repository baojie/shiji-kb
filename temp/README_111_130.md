# 《史记》111-130列传章节批量标注指南

## 概述

本指南说明如何批量处理《史记》111-130列传章节（共20个章节），包括最重要的第130章《太史公自序》。

## 文件说明

- **处理脚本**: `process_chapters_111_130.py`
- **运行脚本**: `run_111_130.sh`
- **进度文件**: `../progress_111_130.json`（自动生成）

## 章节列表

111. 卫将军骠骑列传（卫青、霍去病）
112. 平津侯主父列传
113. 南越列传（民族列传）
114. 东越列传（民族列传）
115. 朝鲜列传（民族列传）
116. 西南夷列传（民族列传）
117. 司马相如列传（含赋作）
118. 淮南衡山列传
119. 循吏列传（类传）
120. 汲郑列传
121. 儒林列传（类传）
122. 酷吏列传（类传）
123. 大宛列传（民族列传）
124. 游侠列传（类传）
125. 佞幸列传（类传）
126. 滑稽列传（类传）
127. 日者列传（类传）
128. 龟策列传（类传）
129. 货殖列传（类传）
130. **太史公自序** ⭐⭐⭐（最重要！）

## 使用步骤

### 方法一：使用Shell脚本（推荐）

1. 设置API密钥：
```bash
export ANTHROPIC_API_KEY='your-api-key-here'
```

或者将API密钥保存到文件：
```bash
echo 'your-api-key-here' > ~/.anthropic_key
```

2. 运行脚本：
```bash
cd /home/baojie/work/shiji-kb
./scripts/run_111_130.sh
```

### 方法二：直接运行Python脚本

```bash
cd /home/baojie/work/shiji-kb
python3 scripts/process_chapters_111_130.py
```

## 功能特性

### 1. 断点续传
脚本会自动保存进度到 `progress_111_130.json`，如果中途中断，可以重新运行继续处理未完成的章节。

### 2. 智能跳过
如果有已完成的章节，脚本会询问是否跳过，默认跳过已完成的章节。

### 3. 详细统计
处理每个章节后，会显示：
- 行数
- 人名标注数量
- 地名标注数量
- 族群标注数量
- 官职标注数量
- Token使用情况

### 4. 错误处理
脚本会记录失败的章节和原因，便于后续重试。

## 标注规则（11类实体）

1. **人名**: `@人名@`
   - 例：@卫青@、@霍去病@、@司马迁@、@司马谈@

2. **地名**: `=地名=`
   - 例：=长安=、=茂陵=、=河西=

3. **官职**: `$官职$`
   - 例：$大将军$、$骠骑将军$、$太史令$

4. **时间/纪年**: `%时间%`
   - 例：%元光五年%、%元狩四年%

5. **朝代/氏族/国号**: `&朝代&`
   - 例：&汉&、&秦&

6. **制度/典章**: `^制度^`
   - 例：^封禅^、^太初历^

7. **族群/部落**: `~族群~`
   - 例：~匈奴~、~南越~、~东越~、~大宛~、~乌孙~、~月氏~

8. **器物/礼器**: `*器物*`
   - 例：*金人*、*玉玺*

9. **天文/历法**: `!天文!`
   - 例：!太初历!

10. **传说/神话**: `?神话?`
    - 例：?封狼居胥?

11. **动植物**: `🌿动植物🌿`
    - 例：🌿马🌿、🌿羊🌿

## 特殊章节处理说明

### 民族列传（113-116, 123）
- 大量使用 `~族群~` 标注
- 按历史沿革组织内容
- 标注重大战役和时间

### 类传（119-129）
- 每个人物独立二级或三级标题
- 总论部分在前
- 太史公曰在后

### 司马相如列传（117）
- 保持《子虚赋》、《上林赋》的完整性
- 长赋适当分段但保持文学性

### 太史公自序（130）⭐⭐⭐
这是《史记》最重要的篇章之一，需要特别细致处理：

#### 内容结构
1. **司马氏家世**
   - @司马错@（秦惠王时将军）
   - @司马昌@（汉文帝时）
   - @司马喜@
   - @司马靳@
   - @司马无泽@
   - @司马谈@（司马迁之父，太史令）

2. **司马迁生平**
   - 早年游历（详细标注地名）
   - 继承父职（%元封元年%任$太史令$）
   - **李陵之祸**（%天汉三年%，为@李陵@辩护，受宫刑）
   - 发愤著书

3. **《史记》著述说明**
   - 体例：本纪、表、书、世家、列传
   - 130篇目录总序
   - 著述宗旨："究天人之际，通古今之变，成一家之言"

#### 标注要点
- 详细标注每一位司马氏祖先
- 精确标注司马迁生平的时间节点
- 细致标注李陵之祸的人名、时间、官职
- 完整标注130篇目录中的所有篇名
- 标注《史记》创作的相关典章制度

## 输出文件

处理后的文件将保存到：
```
/home/baojie/work/shiji-kb/chapter_md/[章节号]_[章节名].tagged.md
```

例如：
- `111_卫将军骠骑列传.tagged.md`
- `130_太史公自序.tagged.md`

## 进度文件格式

`progress_111_130.json` 包含：
```json
{
  "completed": [
    "111_卫将军骠骑列传",
    "112_平津侯主父列传"
  ],
  "failed": {
    "113_南越列传": "错误原因"
  }
}
```

## 预期处理时间

- 单个章节：1-3分钟
- 全部20个章节：30-60分钟
- 使用模型：`claude-sonnet-4-20250514`
- 预计总Token消耗：约50-100万 tokens

## 注意事项

1. **API密钥安全**
   - 不要将API密钥提交到git仓库
   - 建议使用 `~/.anthropic_key` 文件保存

2. **网络连接**
   - 确保网络稳定，处理过程中需要持续连接
   - 如果网络中断，可以重新运行继续处理

3. **磁盘空间**
   - 确保有足够的磁盘空间保存输出文件
   - 每个章节约10-50KB

4. **费用预估**
   - 根据当前Claude API定价估算费用
   - 建议先处理1-2个章节测试

## 验证处理结果

处理完成后，可以使用以下命令验证：

```bash
# 查看已生成的文件
ls -lh chapter_md/1[12]*.tagged.md

# 统计标注数量
grep -o '@[^@]*@' chapter_md/111_卫将军骠骑列传.tagged.md | wc -l

# 查看进度
cat progress_111_130.json
```

## 问题排查

### 问题1：API密钥错误
```
错误: 未设置 ANTHROPIC_API_KEY 环境变量
```
**解决**: 设置正确的API密钥

### 问题2：文件不存在
```
跳过: XXX (文件不存在)
```
**解决**: 检查输入文件路径 `/home/baojie/work/shiji-kb/docs/original_text/`

### 问题3：Token超限
```
处理失败: Token limit exceeded
```
**解决**: 等待一段时间后重试，或者分批处理

## 后续处理

处理完成后，可以：

1. 生成HTML版本：
```bash
python3 render_shiji_html.py
```

2. 验证标注：
```bash
python3 scripts/validate_all_chapters.py
```

3. 提取关系：
```bash
python3 extract_all_relations.py
```

## 联系与反馈

如有问题或建议，请查看项目README或提交Issue。
