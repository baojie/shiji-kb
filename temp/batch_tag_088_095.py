#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ‰¹é‡æ ‡æ³¨å²è®°088-095ç« èŠ‚çš„å®ä½“æ ‡æ³¨è„šæœ¬
"""

import re
import os

# å®ä½“æ ‡æ³¨è§„åˆ™
def tag_entities(text):
    """å¯¹æ–‡æœ¬è¿›è¡Œå®ä½“æ ‡æ³¨"""

    # äººååˆ—è¡¨ (å¸¸è§äººå)
    person_names = [
        'è’™æ¬', 'è’™æ¯…', 'æ‰¶è‹', 'å§‹çš‡', 'å¼ è€³', 'é™ˆé¦€', 'é­è±¹', 'å½­è¶Š', 'é»¥å¸ƒ',
        'éŸ©ä¿¡', 'æ·®é˜´ä¾¯', 'å¢ç»¾', 'ç”°å„‹', 'ç”°è£', 'ç”°æ¨ª', 'æ¨Šå“™', 'éƒ¦å•†', 'æ»•å…¬',
        'çŒå©´', 'é«˜ç¥–', 'é¡¹ç¾½', 'é¡¹æ¢', 'åˆ˜é‚¦', 'å•å', 'æ²›å…¬', 'æ±‰ç‹', 'ç« é‚¯',
        'ç‹ç¦»', 'æç”±', 'å¸é©¬æ¬£', 'è‘£ç¿³', 'èµµé«˜', 'å­å©´', 'é™ˆèƒœ', 'å´å¹¿', '
æ­¦è‡£',
        'æè‰¯', 'ç”°å®‰', 'ç”°å‡', 'å‘¨å¸‚', 'å‘¨æ–‡', 'å¬å¹³', 'å‘¨è‹›', 'é›é½¿', 'ç”³é˜³',
        'å¼ åŒ', 'è´²èµ«', 'æ ¾å¸ƒ', 'é’Ÿç¦»çœ›', 'è’¯é€š', 'éƒ¦é£Ÿå…¶', 'é™†è´¾', 'éšä½•',
        'æ­¦ç‹', 'æˆç‹', 'å‘¨å…¬', 'å¤ªå…¬', 'å­”å­', 'è€å­', 'å¢¨å­', 'ç®¡ä»²', 'æ™å©´'
    ]

    # åœ°ååˆ—è¡¨
    place_names = [
        'å’¸é˜³', 'ä¸Šéƒ¡', 'ä¹åŸ', 'äº‘é˜³', 'é˜³å‘¨', 'ç»›', 'é‚¯éƒ¸', 'å·¨é¹¿', 'é™ˆ', 'ç €',
        'å½­åŸ', 'è¥é˜³', 'æˆçš‹', 'å¹¿æ­¦', 'é¸¿é—¨', 'éœ¸ä¸Š', 'æ­¦å…³', 'å‡½è°·å…³', 'å…³ä¸­',
        'å·´èœ€', 'æ±‰ä¸­', 'å—é˜³', 'é¢å·', 'ä¸‰å·', 'ä¸œéƒ¡', 'ç €éƒ¡', 'è–›', 'æ é˜³',
        'åºŸä¸˜', 'ä¸´æ™‹', 'é«˜å¥´', 'ç¿Ÿ', 'ä»£', 'èµµ', 'ç‡•', 'é½', 'æ¥š', 'é­', 'éŸ©',
        'ç§¦', 'æ±‰', 'é™‡è¥¿', 'åŒ—åœ°', 'è¾½ä¸œ', 'æ²³ä¸œ', 'æ²³å†…', 'æ²³å—', 'å…³ä¸œ',
        'å±±ä¸œ', 'æ±Ÿå—', 'æ·®å—', 'æ·®é˜´', 'ä¸‹é‚³', 'æ²›', 'ä¸°', 'æ›²é€†', 'å†ä¸‹',
        'å³å¢¨', 'ä¸´æ·„', 'èƒ¶ä¸œ', 'æµåŒ—', 'åšé˜³', 'æ˜Œé‚‘', 'èˆé˜³', 'æ±é˜´', 'é¢é˜³'
    ]

    # å®˜èŒåˆ—è¡¨
    official_titles = [
        'ä¸ç›¸', 'å¤ªå°‰', 'å¾¡å²å¤§å¤«', 'å°†å†›', 'ä¸Šå°†å†›', 'å¤§å°†å†›', 'åˆ—ä¾¯', 'è¯¸ä¾¯ç‹',
        'å¤ªå­', 'çš‡å¸', 'å¤©å­', 'ç‹', 'ä¾¯', 'å…¬', 'å¿', 'å¤§å¤«', 'éƒä¸­', 'ä¸­å°‰',
        'å»·å°‰', 'å…¸å®¢', 'å®—æ­£', 'å¤ªä»†', 'éƒ¡å®ˆ', 'å¿ä»¤', 'å¿å°‰', 'äº­é•¿', 'é‡Œæ­£',
        'å¾¡å²', 'åšå£«', 'éƒ', 'èˆäºº', 'ä¸­å¤§å¤«', 'å¤ªä¸­å¤§å¤«', 'è°’è€…', 'éƒä¸­ä»¤',
        'å«å°‰', 'å°‘åºœ', 'æ‰§æˆŸ', 'éƒä¸­éª‘', 'ä¸­æ¶“', 'éª‘å°†', 'è½¦éª‘å°†å†›', 'éª éª‘å°†å†›',
        'éƒ½å°‰', 'æ ¡å°‰', 'å¸é©¬', 'å€™', 'é•¿å²', 'å¸ç©º', 'ä¸', 'ä»¤', 'å°¹'
    ]

    # æœä»£åˆ—è¡¨
    dynasties = ['å¤', 'å•†', 'å‘¨', 'ç§¦', 'æ±‰', 'æ¥š', 'é½', 'ç‡•', 'èµµ', 'é­', 'éŸ©', 'å®‹', 'å«', 'éƒ‘', 'é™ˆ', 'è”¡', 'å´', 'è¶Š', 'æ™‹', 'é²']

    # æ—¶é—´è¡¨è¾¾
    time_patterns = [
        r'(\d+å¹´)', r'(å…ƒå¹´)', r'(\d+æœˆ)', r'(æ˜¥|å¤|ç§‹|å†¬)', r'(æ­£æœˆ|äºŒæœˆ|ä¸‰æœˆ|å››æœˆ|äº”æœˆ|å…­æœˆ|ä¸ƒæœˆ|å…«æœˆ|ä¹æœˆ|åæœˆ|åä¸€æœˆ|åäºŒæœˆ)',
        r'(\d+æ—¥)', r'(ç”²å­|ä¹™ä¸‘|ä¸™å¯…|ä¸å¯|æˆŠè¾°|å·±å·³|åºšåˆ|è¾›æœª|å£¬ç”³|ç™¸é…‰|ç”²æˆŒ|ä¹™äº¥)',
        r'(æœ”|æœ›|æ™¦)', r'(\d+å²)', r'(\d+ä¸–)'
    ]

    # åˆ¶åº¦è¯æ±‡
    institutions = [
        'å°å»º', 'éƒ¡å¿', 'åˆ†å°', 'äº•ç”°', 'ç¤¼ä¹', 'åˆ‘æ³•', 'å¾‹ä»¤', 'æ³•ä»¤', 'è¯ä»¤',
        'ç§‘ä¸¾', 'å¯Ÿä¸¾', 'å¾è¾Ÿ', 'å®—æ³•', 'å«¡é•¿å­', 'å®—åº™', 'ç¤¾ç¨·', 'æœè´¡', 'å°ç¦…',
        'å·¡ç‹©', 'ç”°çŒ', 'é˜¡é™Œ', 'åº¦é‡è¡¡', 'ä»€ä¼', 'è¿å', 'å†›åŠŸ', 'çˆµä½', 'ä¿¸ç¦„',
        'èµ‹ç¨', 'å¾­å½¹', 'æˆè¾¹', 'å±¯ç”°', 'ç›Ÿçº¦', 'å’Œäº²'
    ]

    # æ ‡æ³¨äººå
    for name in person_names:
        if len(name) >= 2:
            text = re.sub(f'({name})', r'@\1@', text)

    # æ ‡æ³¨åœ°å
    for place in place_names:
        if len(place) >= 2:
            # é¿å…é‡å¤æ ‡æ³¨
            text = re.sub(f'(?<![=@$%&^~*!?ğŸŒ¿])({place})(?![=@$%&^~*!?ğŸŒ¿])', r'=\1=', text)

    # æ ‡æ³¨æœä»£
    for dynasty in dynasties:
        text = re.sub(f'(?<![=@$%&^~*!?ğŸŒ¿])({dynasty})(?![=@$%&^~*!?ğŸŒ¿å›½])', r'&\1&', text)

    # æ ‡æ³¨å®˜èŒ
    for title in official_titles:
        if len(title) >= 2:
            text = re.sub(f'(?<![=@$%&^~*!?ğŸŒ¿])({title})(?![=@$%&^~*!?ğŸŒ¿])', r'$\1$', text)

    # æ ‡æ³¨åˆ¶åº¦
    for inst in institutions:
        if len(inst) >= 2:
            text = re.sub(f'(?<![=@$%&^~*!?ğŸŒ¿])({inst})(?![=@$%&^~*!?ğŸŒ¿])', r'^\1^', text)

    # æ ‡æ³¨æ—¶é—´
    for pattern in time_patterns:
        text = re.sub(pattern, r'%\1%', text)

    # æ ‡æ³¨å™¨ç‰©
    artifacts = ['å‰‘', 'æˆŸ', 'çŸ›', 'å¼“', 'å¼©', 'ç®­', 'è½¦', 'é©¬', 'èˆ¹', 'èˆŸ', 'é¼', 'é’Ÿ', 'ç’§', 'ç‰', 'é‡‘', 'é“¶', 'é“œ', 'é“', 'ä¸', 'å¸›', 'é”¦', 'ç»£', 'å† ', 'è¡£', 'å°', 'çº', 'ç¬¦', 'èŠ‚', 'æ——', 'é¼“']
    for artifact in artifacts:
        text = re.sub(f'(?<![=@$%&^~*!?ğŸŒ¿ğŸğŸ•ğŸ‘ğŸ„ğŸ´ğŸ…ğŸ°ğŸ¦ŒğŸ­])({artifact})(?![=@$%&^~*!?ğŸŒ¿ğŸğŸ•ğŸ‘ğŸ„ğŸ´ğŸ…ğŸ°ğŸ¦ŒğŸ­])', r'*\1*', text)

    # æ ‡æ³¨åŠ¨ç‰©
    animals = ['é©¬', 'ç‰›', 'ç¾Š', 'çŠ¬', 'é¸¡', 'è±•', 'é¾™', 'è™', 'é¹¿', 'ç‹¼', 'ç‹', 'å…”', 'é¼ ', 'è±¡', 'çŠ€', 'ç†Š', 'ç½´', 'é¸Ÿ', 'é¹°', 'éš¼', 'é›', 'é¸¦', 'é¸¦']
    for animal in animals:
        emoji_map = {'é©¬': 'ğŸ', 'ç‰›': 'ğŸ„', 'ç¾Š': 'ğŸ‘', 'çŠ¬': 'ğŸ•', 'è™': 'ğŸ…', 'é¹¿': 'ğŸ¦Œ', 'å…”': 'ğŸ°', 'é¼ ': 'ğŸ­', 'é©´': 'ğŸ´'}
        emoji = emoji_map.get(animal, 'ğŸŒ¿')
        text = re.sub(f'(?<![=@$%&^~*!?ğŸŒ¿ğŸğŸ•ğŸ‘ğŸ„ğŸ´ğŸ…ğŸ°ğŸ¦ŒğŸ­])({animal})(?![=@$%&^~*!?ğŸŒ¿ğŸğŸ•ğŸ‘ğŸ„ğŸ´ğŸ…ğŸ°ğŸ¦ŒğŸ­])', f'{emoji}\\1{emoji}', text)

    return text

def process_chapter(input_file, output_file):
    """å¤„ç†å•ä¸ªç« èŠ‚"""
    with open(input_file, 'r', encoding='utf-8') as f:
        lines = f.readlines()

    # è·å–æ ‡é¢˜
    title = lines[0].strip() if lines else ""
    chapter_num = re.search(r'(\d+)', title).group(1) if re.search(r'\d+', title) else "000"

    output_lines = []
    output_lines.append(f"# {chapter_num} {title}\n\n")
    output_lines.append(f"## æ ‡é¢˜\n")
    output_lines.append(f"{tag_entities(title)}\n\n")

    # å¤„ç†æ­£æ–‡
    section_num = 1
    for i, line in enumerate(lines[1:], 1):
        line = line.strip()
        if not line:
            continue

        # æ·»åŠ æ®µè½ç¼–å·
        output_lines.append(f"## [{section_num}] ç¬¬{section_num}æ®µ\n\n")
        output_lines.append(f"[{section_num}.1] {tag_entities(line)}\n\n")
        section_num += 1

    # å†™å…¥è¾“å‡ºæ–‡ä»¶
    with open(output_file, 'w', encoding='utf-8') as f:
        f.writelines(output_lines)

    print(f"å·²å®Œæˆ: {output_file}")

if __name__ == "__main__":
    base_dir = "/home/baojie/work/shiji-kb/docs/original_text"
    output_dir = "/home/baojie/work/shiji-kb/chapter_md"

    chapters = [
        "088_è’™æ¬åˆ—ä¼ ",
        "089_å¼ è€³é™ˆé¦€åˆ—ä¼ ",
        "090_é­è±¹å½­è¶Šåˆ—ä¼ ",
        "091_é»¥å¸ƒåˆ—ä¼ ",
        "092_æ·®é˜´ä¾¯åˆ—ä¼ ",
        "093_éŸ©ä¿¡å¢ç»¾åˆ—ä¼ ",
        "094_ç”°å„‹åˆ—ä¼ ",
        "095_æ¨Šéƒ¦æ»•çŒåˆ—ä¼ "
    ]

    for chapter in chapters:
        input_file = os.path.join(base_dir, f"{chapter}.txt")
        output_file = os.path.join(output_dir, f"{chapter}.tagged.md")

        if os.path.exists(input_file):
            process_chapter(input_file, output_file)
        else:
            print(f"æ–‡ä»¶ä¸å­˜åœ¨: {input_file}")

    print("\næ‰€æœ‰ç« èŠ‚å¤„ç†å®Œæˆ!")
