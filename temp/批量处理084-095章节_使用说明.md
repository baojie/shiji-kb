# 《史记》084-095列传章节批量处理说明

## 概述

本文档说明如何批量处理《史记》084-095章节（列传部分）的标注工作。

## 章节列表

待处理章节共12个：

1. 084_屈原贾生列传
2. 085_吕不韦列传
3. 086_刺客列传
4. 087_李斯列传
5. 088_蒙恬列传
6. 089_张耳陈馀列传
7. 090_魏豹彭越列传
8. 091_黥布列传
9. 092_淮阴侯列传
10. 093_韩信卢绾列传
11. 094_田儋列传
12. 095_樊郦滕灌列传

## 文件位置

- **输入目录**: `/home/baojie/work/shiji-kb/docs/original_text/`
- **输出目录**: `/home/baojie/work/shiji-kb/chapter_md/`
- **处理脚本**: `/home/baojie/work/shiji-kb/scripts/process_chapters_084_095.py`
- **启动脚本**: `/home/baojie/work/shiji-kb/scripts/start_processing_084_095.sh`

## 标注规则（11类实体）

### 1. 人名
- **标注符号**: `@人名@`
- **示例**: `@屈原@`、`@贾谊@`、`@李斯@`、`@韩信@`

### 2. 地名
- **标注符号**: `=地名=`
- **示例**: `=楚国=`、`=咸阳=`、`=关中=`、`=汨罗=`

### 3. 官职
- **标注符号**: `$官职$`
- **示例**: `$丞相$`、`$太尉$`、`$大将军$`、`$左徒$`

### 4. 时间/纪年
- **标注符号**: `%时间%`
- **示例**: `%秦始皇二十六年%`、`%汉高祖五年%`

### 5. 朝代/氏族/国号
- **标注符号**: `&朝代&`
- **示例**: `&秦&`、`&楚&`、`&汉&`、`&赵&`

### 6. 制度/典章
- **标注符号**: `^制度^`
- **示例**: `^郡县制^`、`^三公九卿^`

### 7. 族群/部落
- **标注符号**: `~族群~`
- **示例**: `~匈奴~`、`~楚人~`

### 8. 器物/礼器
- **标注符号**: `*器物*`
- **示例**: `*剑*`、`*玉玺*`、`*和氏璧*`

### 9. 天文/历法
- **标注符号**: `!天文!`
- **示例**: `!彗星!`、`!日食!`

### 10. 传说/神话
- **标注符号**: `?神话?`
- **示例**: `?凤凰?`、`?龙?`

### 11. 动植物
- **标注符号**: `🌿动植物🌿`
- **示例**: `🌿马🌿`、`🌿兰草🌿`、`🌿鸮🌿`

## 列传标注特殊注意事项

### 1. 人物关系
- 列传记录历史人物传记，需要注意标注人物间的关系
- 师徒关系：如`@张良@`师从`@黄石公@`
- 朋友关系：如`@张耳@`与`@陈馀@`
- 政治关系：君臣、同僚、敌对等

### 2. 对话处理
- 对话使用引用块（`>` 符号）
- 长对话前添加NOTE说明，如：
  ```markdown
  > NOTE: 李斯谏逐客书
  >
  > @李斯@曰："臣闻地广者粟多，国大者人众..."
  ```

### 3. 历史事件
- 重要事件设三级标题
- 示例：
  ```markdown
  ### 荆轲刺秦王
  ### 完璧归赵
  ### 背水一战
  ```

### 4. 合传处理
- 一个列传包含多人时，为每个主要人物设立二级标题
- 示例：
  ```markdown
  ## 屈原
  ### 早年与得志
  ### 被谗去职

  ## 贾谊
  ### 出身与早年
  ### 入仕与被贬
  ```

### 5. 文档结构
- **一级标题**：`# [0] 列传名`
- **二级标题**：按人物划分
- **三级标题**：按重要事件划分
- **段落编号**：圣经式编号 `[章.节]`

## 使用方法

### 方法一：使用启动脚本（推荐）

```bash
cd /home/baojie/work/shiji-kb
./scripts/start_processing_084_095.sh
```

启动脚本会：
1. 检查Python环境和依赖
2. 提示输入API密钥（如果未设置）
3. 显示待处理章节列表
4. 确认后开始批量处理

### 方法二：直接运行Python脚本

```bash
cd /home/baojie/work/shiji-kb

# 设置API密钥
export ANTHROPIC_API_KEY="your_api_key_here"

# 运行处理脚本
python3 scripts/process_chapters_084_095.py
```

### 方法三：处理单个章节

如果只想处理某个特定章节，可以修改脚本中的 `CHAPTERS` 列表：

```python
# 编辑 scripts/process_chapters_084_095.py
CHAPTERS = [
    "084_屈原贾生列传",  # 只处理这一个
]
```

## 输出格式示例

```markdown
# [0] 屈原贾生列传

## 屈原

### 早年与得志

[1.1] @屈原@者，名@平@，&楚&之$同姓$也。为&楚怀王&$左徒$。

[1.2] 博闻彊志，明於治乱，嫺於辞令。入则与$王$图议$国事$，以出$号令$；出则接遇$宾客$，应对诸侯。$王$甚任之。

### 被谗去职

[2.1] $上官大夫$与之同列，争宠而心害其能。

[2.2] @怀王@使@屈原@造为^宪令^，@屈平@属草未定。

> NOTE: 上官大夫的谗言

[2.3] $上官大夫$见而欲夺之，@屈平@不与，因谗之曰：

> "$王$使@屈平@为$令$，众莫不知，每一令出，@平@伐其功，以为'非我莫能为'也。"

[2.4] $王$怒而疏@屈平@。

### 流放与自沉

[3.1] @屈原@至於=江滨=，被发行吟=泽畔=。颜色憔悴，形容枯槁。

[3.2] 渔父见而问之曰："子非$三闾大夫$欤？何故而至此？"

> NOTE: 屈原与渔父的对话

[3.3] @屈原@曰："举世混浊而我独清，众人皆醉而我独醒，是以见放。"

[3.4] 於是怀石遂自=汨罗=以死。
```

## 处理流程

脚本会自动完成以下步骤：

1. **读取原文**: 从 `docs/original_text/` 读取章节文本
2. **调用Claude API**: 使用Claude Sonnet 4进行智能标注
3. **生成Markdown**: 输出结构化的Markdown文件
4. **保存结果**: 保存到 `chapter_md/` 目录
5. **显示统计**: 显示标注统计信息（人名、地名等数量）

## 预期处理时间

- 单个章节：约30-60秒
- 全部12个章节：约10-15分钟
- 总Token消耗：约80,000-120,000 tokens

## 质量检查

处理完成后，建议检查：

1. **文档结构**：标题层级是否正确
2. **段落编号**：是否连续、格式正确
3. **实体标注**：
   - 人名是否完整标注
   - 对话中的人名、地名是否标注
   - 官职、朝代是否标注
4. **特殊内容**：
   - 诗赋部分是否保留原文格式
   - 对话是否使用引用块
   - 长对话是否添加NOTE说明

## 故障排除

### 1. API密钥错误
```
❌ 错误: 未设置 ANTHROPIC_API_KEY 环境变量
```
**解决方法**: 设置环境变量
```bash
export ANTHROPIC_API_KEY="your_api_key_here"
```

### 2. 依赖库未安装
```
❌ 错误: No module named 'anthropic'
```
**解决方法**: 安装依赖
```bash
pip3 install anthropic
```

### 3. 文件不存在
```
⚠️  跳过: 084_屈原贾生列传 (文件不存在)
```
**解决方法**: 检查文件路径和名称是否正确

### 4. Token超限
如果单个章节太长导致token超限，可以：
- 增加 `max_tokens` 参数值
- 或将长章节拆分处理

## 输出文件

处理完成后，每个章节会生成对应的 `.tagged.md` 文件：

```
chapter_md/
├── 084_屈原贾生列传.tagged.md
├── 085_吕不韦列传.tagged.md
├── 086_刺客列传.tagged.md
├── 087_李斯列传.tagged.md
├── 088_蒙恬列传.tagged.md
├── 089_张耳陈馀列传.tagged.md
├── 090_魏豹彭越列传.tagged.md
├── 091_黥布列传.tagged.md
├── 092_淮阴侯列传.tagged.md
├── 093_韩信卢绾列传.tagged.md
├── 094_田儋列传.tagged.md
└── 095_樊郦滕灌列传.tagged.md
```

## 后续步骤

处理完成后可以：

1. 使用验证脚本检查标注质量
2. 将标注文件转换为HTML格式
3. 将处理结果添加到git仓库
4. 更新游戏数据（如果需要）

## 技术参数

- **Claude模型**: claude-sonnet-4-20250514
- **Temperature**: 0 (确保一致性)
- **Max tokens**: 16000
- **编码**: UTF-8
- **输出格式**: Markdown

## 联系与支持

如有问题，请检查：
1. 本说明文档
2. 脚本输出的错误信息
3. API密钥是否有效
4. 网络连接是否正常

---

**创建时间**: 2026-02-06
**版本**: 1.0
**适用章节**: 084-095（列传）
