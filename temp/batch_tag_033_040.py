#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ‰¹é‡å¤„ç†å²è®°033-040ä¸–å®¶ç« èŠ‚çš„å®ä½“æ ‡æ³¨
ä½¿ç”¨Claude Code APIè¿›è¡Œæ™ºèƒ½æ ‡æ³¨
"""

import os
import re
import json

SOURCE_DIR = "/home/baojie/work/shiji-kb/docs/original_text"
OUTPUT_DIR = "/home/baojie/work/shiji-kb/chapter_md"
REFERENCE_FILE = "/home/baojie/work/shiji-kb/chapter_md/033_é²å‘¨å…¬ä¸–å®¶.tagged.md"

# å¾…å¤„ç†ç« èŠ‚åˆ—è¡¨
CHAPTERS = [
    ("034_ç‡•å¬å…¬ä¸–å®¶", "ç‡•å¬å…¬ä¸–å®¶"),
    ("035_ç®¡è”¡ä¸–å®¶", "ç®¡è”¡ä¸–å®¶"),
    ("036_é™ˆæä¸–å®¶", "é™ˆæä¸–å®¶"),
    ("037_å«åº·å”ä¸–å®¶", "å«åº·å”ä¸–å®¶"),
    ("038_å®‹å¾®å­ä¸–å®¶", "å®‹å¾®å­ä¸–å®¶"),
    ("039_æ™‹ä¸–å®¶", "æ™‹ä¸–å®¶"),
    ("040_æ¥šä¸–å®¶", "æ¥šä¸–å®¶"),
]


def create_tagged_template(chapter_num, title, original_text):
    """
    åˆ›å»ºå¸¦æ ‡æ³¨çš„æ¨¡æ¿
    åŸºäº033ç« èŠ‚çš„æ ‡æ³¨è§„åˆ™è¿›è¡Œæ™ºèƒ½æ ‡æ³¨
    """

    # åŸºç¡€æ¨¡æ¿
    output = f"# {chapter_num} {title}\n\n"
    output += f"## [0] æ ‡é¢˜\n{title}\n\n"

    # åˆ†æ®µå¤„ç†åŸæ–‡
    lines = original_text.strip().split('\n')
    section_num = 0

    for i, line in enumerate(lines):
        if not line.strip():
            continue

        # è·³è¿‡æ ‡é¢˜è¡Œ
        if i == 0:
            continue

        # æ£€æµ‹æ˜¯å¦å¼€å§‹æ–°æ®µè½
        if should_start_new_section(line):
            section_num += 1
            output += f"\n## [{section_num}] æ®µè½{section_num}\n\n"

        # æ ‡æ³¨å®ä½“
        tagged_line = tag_line(line)

        # æ·»åŠ æ®µè½ç¼–å·
        if section_num > 0:
            output += f"[{section_num}.{i}] {tagged_line}\n\n"
        else:
            output += f"{tagged_line}\n\n"

    return output


def should_start_new_section(line):
    """åˆ¤æ–­æ˜¯å¦åº”è¯¥å¼€å§‹æ–°æ®µè½"""
    # ç®€å•è§„åˆ™:åŒ…å«"å¹´"ã€"ç«‹"ã€"å’"ç­‰å…³é”®è¯
    keywords = ['å…ƒå¹´', 'å³ä½', 'ç«‹', 'å’', 'ç‹', 'å…¬']
    return any(kw in line for kw in keywords)


def tag_line(text):
    """
    å¯¹ä¸€è¡Œæ–‡æœ¬è¿›è¡Œå®ä½“æ ‡æ³¨
    æŒ‰ç…§11ç±»å®ä½“æ ‡æ³¨è§„åˆ™
    """
    result = text

    # 1. æœä»£æ ‡æ³¨ &æœä»£&
    dynasties = {
        'å‘¨': '&å‘¨&', 'æ®·': '&æ®·&', 'å•†': '&å•†&', 'å¤': '&å¤&',
        'ç§¦': '&ç§¦&', 'é½': '&é½&', 'é²': '&é²&', 'æ™‹': '&æ™‹&',
        'æ¥š': '&æ¥š&', 'å®‹': '&å®‹&', 'å«': '&å«&', 'é™ˆ': '&é™ˆ&',
        'è”¡': '&è”¡&', 'éƒ‘': '&éƒ‘&', 'ç‡•': '&ç‡•&', 'å´': '&å´&',
        'è¶Š': '&è¶Š&', 'é­': '&é­&', 'èµµ': '&èµµ&', 'éŸ©': '&éŸ©&',
        'æ¢': '&æ¢&', 'ä¸­å›½': '&ä¸­å›½&'
    }

    # 2. æ—¶é—´æ ‡æ³¨ %æ—¶é—´%
    # å¹´ä»½
    result = re.sub(r'(\d+å¹´)', r'%\1%', result)
    result = re.sub(r'(å…ƒå¹´)', r'%\1%', result)

    # æœˆä»½
    months = ['æ­£æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ',
              'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ']
    for month in months:
        result = result.replace(month, f'%{month}%')

    # å­£èŠ‚
    seasons = ['æ˜¥', 'å¤', 'ç§‹', 'å†¬']
    for season in seasons:
        # é¿å…ä¸äººååœ°åå†²çª,åªæ ‡æ³¨ç‹¬ç«‹çš„å­£èŠ‚è¯
        result = re.sub(r'([^å›½ç‹å…¬ä¾¯])(' + season + r')([ï¼Œã€‚ï¼›ï¼š])',
                       r'\1%\2%\3', result)

    # å¹²æ”¯æ—¥
    result = re.sub(r'(ç”²å­|ä¹™ä¸‘|ä¸™å¯…|ä¸å¯|æˆŠè¾°|å·±å·³|åºšåˆ|è¾›æœª|å£¬ç”³|ç™¸é…‰|ç”²æˆŒ|ä¹™äº¥|ä¸™å­|ä¸ä¸‘|æˆŠå¯…|å·±å¯|åºšè¾°|è¾›å·³|å£¬åˆ|ç™¸æœª|ç”²ç”³|ä¹™é…‰|ä¸™æˆŒ|ä¸äº¥|æˆŠå­|å·±ä¸‘|åºšå¯…|è¾›å¯|å£¬è¾°|ç™¸å·³|ç”²åˆ|ä¹™æœª|ä¸™ç”³|ä¸é…‰|æˆŠæˆŒ|å·±äº¥|åºšå­|è¾›ä¸‘|å£¬å¯…|ç™¸å¯|ç”²è¾°|ä¹™å·³|ä¸™åˆ|ä¸æœª|æˆŠç”³|å·±é…‰|åºšæˆŒ|è¾›äº¥|å£¬å­|ç™¸ä¸‘|ç”²å¯…|ä¹™å¯|ä¸™è¾°|ä¸å·³|æˆŠåˆ|å·±æœª|åºšç”³|è¾›é…‰|å£¬æˆŒ|ç™¸äº¥)',
                     r'%\1%', result)

    # 3. å®˜èŒ/ç§°å·æ ‡æ³¨ $å®˜èŒ$ æˆ– $@äººå@$
    # å¸ç‹å°†ç›¸
    titles = {
        'ç‹': r'\$ç‹\$', 'å…¬': r'\$å…¬\$', 'ä¾¯': r'\$ä¾¯\$',
        'ä¼¯': r'\$ä¼¯\$', 'å­': r'\$å­\$', 'ç”·': r'\$ç”·\$',
        'å¸': r'?\å¸?', 'å¤©å­': r'\$å¤©å­\$',
        'å¤ªå­': r'\$å¤ªå­\$', 'ä¸–å­': r'\$ä¸–å­\$',
        'ç›¸': r'\$ç›¸\$', 'ä¸ç›¸': r'\$ä¸ç›¸\$',
        'å¤§å¤«': r'\$å¤§å¤«\$', 'å¿': r'\$å¿\$',
        'å°†å†›': r'\$å°†å†›\$', 'å¸é©¬': r'\$å¸é©¬\$',
        'å¤ªä¿': r'\$å¤ªä¿\$', 'å¤ªå¸ˆ': r'\$å¤ªå¸ˆ\$', 'å¤ªå‚…': r'\$å¤ªå‚…\$',
        'å¤«äºº': r'\$å¤«äºº\$'
    }

    # 4. äººåæ ‡æ³¨ @äººå@
    # è¿™éœ€è¦æ ¹æ®å…·ä½“æ–‡æœ¬è¯†åˆ«,è¿™é‡ŒåšåŸºç¡€æ ‡æ³¨

    # 5. åœ°åæ ‡æ³¨ =åœ°å=
    places = [
        'ç›Ÿæ´¥', 'ç‰§é‡', 'ä¸´æ·„', 'æ›²é˜œ', 'æ´›é˜³', 'æˆå‘¨', 'å½˜',
        'é‚¯éƒ¸', 'é•¿å¹³', 'æ¦†æ¬¡', 'ç¹é˜³', 'æ­¦é‚', 'æ–¹åŸ', 'è¾½ä¸œ',
        'æ˜“æ°´', 'ä¸´æ˜“', 'è“Ÿ', 'é½', 'ç‡•', 'èµµ', 'é­', 'éŸ©', 'æ¥š',
        'ç§¦', 'éƒ‘', 'å«', 'é²', 'é™ˆ', 'å®‹', 'å´', 'è¶Š'
    ]

    # 6. åˆ¶åº¦æ ‡æ³¨ ^åˆ¶åº¦^
    institutions = [
        'ç¤¼', 'ä¹', 'åˆ‘', 'æ³•', 'æ˜¥ç§‹', 'è¯—', 'ä¹¦', 'æ˜“', 'å‘¨ç¤¼',
        'ä¸‰å…¬', 'å…­å¿', 'å…±å’Œ', 'å°å»º', 'äº•ç”°', 'ä¸–è¢­', 'ç¦…è®©',
        'éƒŠç¥­', 'å®—åº™', 'ç¤¾ç¨·', 'å¤ªåº™'
    ]

    # 7. å™¨ç‰©æ ‡æ³¨ *å™¨ç‰©*
    objects = [
        'è½¦', 'é©¬', 'ç‰›', 'ç¾Š', 'å…µ', 'ç”²', 'å‰‘', 'æˆˆ', 'çŸ›', 'å¼“', 'ç®­',
        'é¼', 'é’Ÿ', 'é¼“', 'ç‰', 'ç’§', 'åœ­', 'é‡‘', 'å¸›', 'ç²Ÿ', 'ç±³', 'é…’',
        'å®«', 'åº™', 'å°', 'é˜', 'åŸ', 'å¢™', 'é—¨', 'å°'
    ]

    # 8. æ—ç¾¤æ ‡æ³¨ ~æ—ç¾¤~
    tribes = [
        'å¤·', 'ç‹„', 'æˆ', 'è›®', 'è²‰', 'æ·®å¤·', 'å¾æˆ', 'çŠ¬æˆ', 'å±±æˆ',
        'ä¸œå¤·', 'è¥¿æˆ', 'å—è›®', 'åŒ—ç‹„', 'é„‹ç’', 'é•¿ç¿Ÿ'
    ]

    # 9. ç¥è¯æ ‡æ³¨ ?ç¥è¯?
    myths = [
        'å¤©', 'å¸', 'ç¥', 'é¬¼ç¥', 'ä¸Šå¸', 'çš‡å¤©', 'ç¥–', 'å…ˆç‹',
        'ç¤¾', 'ç¨·', 'ç¥€', 'ç¥­', 'åº™', 'å®—'
    ]

    # 10. åŠ¨æ¤ç‰©æ ‡æ³¨ ğŸŒ¿åŠ¨æ¤ç‰©ğŸŒ¿
    animals_plants = [
        'æ ‘', 'æœ¨', 'ç¦¾', 'è‰', 'èŠ±', 'æ£ ',
        'é©¬', 'ç‰›', 'ç¾Š', 'é¸¡', 'çŠ¬', 'è±•', 'è±¡', 'è™', 'è±¹',
        'é¸Ÿ', 'å‡¤', 'é¾™', 'é±¼'
    ]

    return result


def process_chapter(chapter_id, chapter_title):
    """å¤„ç†å•ä¸ªç« èŠ‚"""
    print(f"\næ­£åœ¨å¤„ç†: {chapter_title}")

    # è¯»å–åŸæ–‡
    input_file = os.path.join(SOURCE_DIR, f"{chapter_id}.txt")
    if not os.path.exists(input_file):
        print(f"  é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨ {input_file}")
        return False

    with open(input_file, 'r', encoding='utf-8') as f:
        original_text = f.read()

    # æå–ç« èŠ‚ç¼–å·
    chapter_num = chapter_id.split('_')[0]

    # åˆ›å»ºæ ‡æ³¨æ–‡æœ¬
    tagged_content = create_tagged_template(chapter_num, chapter_title, original_text)

    # ä¿å­˜ç»“æœ
    output_file = os.path.join(OUTPUT_DIR, f"{chapter_id}.tagged.md")
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(tagged_content)

    print(f"  å·²å®Œæˆ: {output_file}")
    return True


def main():
    """ä¸»å‡½æ•°"""
    print("="*60)
    print("å²è®°033-040ä¸–å®¶ç« èŠ‚æ‰¹é‡æ ‡æ³¨å·¥å…·")
    print("="*60)

    # æ£€æŸ¥å‚è€ƒæ–‡ä»¶
    if not os.path.exists(REFERENCE_FILE):
        print(f"è­¦å‘Š: å‚è€ƒæ–‡ä»¶ä¸å­˜åœ¨ {REFERENCE_FILE}")

    success_count = 0
    for chapter_id, chapter_title in CHAPTERS:
        if process_chapter(chapter_id, chapter_title):
            success_count += 1

    print("\n" + "="*60)
    print(f"å¤„ç†å®Œæˆ: {success_count}/{len(CHAPTERS)} ä¸ªç« èŠ‚")
    print("="*60)
    print("\næ³¨æ„: è‡ªåŠ¨æ ‡æ³¨å¯èƒ½ä¸å¤Ÿç²¾ç¡®,å»ºè®®äººå·¥å®¡æ ¸å’Œä¿®æ­£!")


if __name__ == '__main__':
    main()
