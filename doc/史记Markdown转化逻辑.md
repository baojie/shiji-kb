# 《史记》语义化 Markdown 转化逻辑

本文档旨在详述将《史记》原始或改进后的文本（TXT）转化为具有语义结构的 Markdown 格式的准则。核心原则是**体现文本的内在逻辑关系**。

---

## 0. 完整处理流程

假设要处理第 N 章（如 005_秦本纪），完整的处理流程如下：

### 步骤 1：获取原始文本
- 从 `chapter_numbered/` 目录下找到 `N_*.txt` 文件
- 例如：`chapter_numbered/005_秦本纪.txt`

### 步骤 2：语义化标注（生成 tagged.md）
根据本文档的转化逻辑进行处理：
1. **章节划分**：根据历史人物、时期或大的叙事单元划分章节
2. **段落拆分**：
   - 控制段落长度（叙事段落不超过150字符）
   - 拆分对话段落（每个"X曰"独立成行）
   - 使用子段落编号（如 [N.1]、[N.2]）
3. **实体识别**（使用大模型NER能力）：
   - 识别人名、地名、官职、时间、朝代、制度、族群、器物、天文、神话、动植物
   - 根据上下文判断词性，只标记名词性实体
   - 避免误标动词、成语、抽象概念
4. **生成文件**：`chapter_md/N_*.tagged.md`
   - 例如：`chapter_md/005_秦本纪.tagged.md`

### 步骤 3：批量生成 HTML（推荐）
使用批量生成脚本将所有章节转换为 HTML 并生成索引页面：
```bash
python generate_all_chapters.py
```
- 自动发现 `chapter_md` 目录下所有 `.tagged.md` 文件
- 为每个章节生成 HTML 文件，包含上一章/下一章导航链接
- 自动生成/更新 `docs/index.html` 索引页面
- 输出文件：`chapter_md/N_*.tagged.html`

**单文件转换**（仅在需要单独处理某个文件时使用）：
```bash
python render_shiji_html.py chapter_md/N_*.tagged.md
```

### 步骤 4：发布到 docs 目录
运行发布脚本，将可发布文件复制到 `/docs` 目录：
```bash
./publish_to_docs.sh
```
- 这会将 HTML 文件和相关资源复制到 `docs/` 目录
- 用于 GitHub Pages 或其他静态网站托管

### 完整示例
```bash
# 假设处理 005_秦本纪
# 1. 原始文件位于：chapter_numbered/005_秦本纪.txt
# 2. 使用大模型进行实体识别和标注，生成：chapter_md/005_秦本纪.tagged.md
# 3. 批量生成所有章节的 HTML 和索引页面
python generate_all_chapters.py
# 4. 发布到 docs
./publish_to_docs.sh
```

---

## 1. 层级结构 (Hierarchical Structure)

### 1.1 标题等级

- **一级标题 (`#`)**: 章节全名 (如 `# 五帝本纪`)。
- **二级标题 (`##`)**: 主体人物、时期或大的叙事单元 (如帝王名 `## 黄帝`)。
- **三级标题 (`###`)**: 核心人物下的具体维度，如“疆域治理”、“家世背景”、“轶事传说”等。

### 1.2 内容分隔

- 在重大的逻辑转换点（如从一位帝王切换到另一位帝王）使用水平分割线 (`---`)。

---

## 2. 并列结构 (Parallel Structure)

对于古代汉语中常见的列举性、并列性内容，应当采用 Markdown 列表以提升结构化水平：

- **血缘/世系**: 如列举子嗣及其封地。
- **官制/职责**: 明确各官员的职能。
- **地理/方位**: 如东南西北的具体疆域描述。
- **历法/节气**: 如羲和四子的季节职责。

**示例**:

> - 其一曰**玄嚣**，是为青阳；
> - 其二曰**昌意**，降居若水。

---

## 3. 语义化增强 (Semantic Enhancement)

利用特定的 Markdown 语法来区分不同性质的文本内容：

### 3.1 轶事与侧写

- 针对篇幅较长、具有故事性或独立性的片段（如“舜受磨难”），使用开始/结束式的 **警告/注意框** 来进行视觉隔离：
  - 开始语法： `> [!NOTE]` 或可带语义标签的 `> [!NOTE tag]` （例如 `> [!NOTE warning]`）
  - 结束语法： `> [!ENDNOTE]`
  - 渲染器会把该区块转换为 `<div class="note-box [note-tag]"><h4>NOTE — tag</h4>...</div>`，便于对特定类型的注记应用不同样式或语义处理。

### 3.2 评价与总结

- **太史公曰**: 保留作为章节收尾的固定板块，使用 `## 太史公曰`。
- **赞 (Zan)**: 针对文末押韵的总结性文字，使用 **引用块 (`> `)** 格式，体现其文学性。
  - **每句换行**：赞通常为韵文，每句以句号（。）或感叹号（！）结尾，应当每句独立成行，便于阅读和体现韵律。
  - **HTML 渲染**：渲染器会在每行末尾自动添加 `<br>` 标签，确保诗歌在浏览器中每句独立显示，保持韵文的视觉格式。
  - 示例：
    ```markdown
    ### 赞

    > [28] 尧遭鸿水，黎人阻饥。
    > 禹勤沟洫，手足胼胝。
    > 言乘四载，动履四时。
    > 娶妻有日，过门不私。
    ```
    渲染为：
    ```html
    <h3>赞</h3>
    <blockquote>
    [28] 尧遭鸿水，黎人阻饥。<br>
    禹勤沟洫，手足胼胝。<br>
    言乘四载，动履四时。<br>
    娶妻有日，过门不私。<br>
    </blockquote>
    ```

### 3.3 实体高亮与语义化标记（Token 约定与转换管道）

为了提升古文阅读体验并支持工程化处理，对不同类型的命名实体采用可机器识别且对人友好的短记号（token）进行标注；样式由集中 CSS 控制，内容与样式分离。

- 设计原则：
  - 最小侵入：保留原文字符，标注使用简短的包裹符号，便于人工阅读与编辑。
  - 语义明确：每种实体对应一个语义类别（CSS 类）以便统一渲染与检索。
  - 可配置：常见的氏族/部族名单应外置为配置文件以便维护与扩展。

#### Token 与 CSS 映射（常用）

- 人名: @人名@ → `.person`
- 地名: =地名= → `.place`
- 官职: $官职$ → `.official`
- 时间/纪年: %时间% → `.time`
- 朝代/氏族/国号: &朝代& → `.dynasty`（可选改为 `.clan`，详见下文）
- 制度/典章: ^制度^ → `.institution`
- 族群/部落: ~族群~ → `.tribe`
- 器物/礼器/书名（注意冲突）: *器物* → `.artifact`（若与 Markdown emphasis 冲突，优先使用转义或双星表示加粗）
- 天文/历法: !天文! → `.astronomy`
- 传说/神话: ?神话? → `.mythical`
- **动植物**: 🌿动植物🌿 → `.flora-fauna`
- **引号内容（对话）**: "内容" / '内容' / 「内容」 / 『内容』 → `.quoted`（自动识别，无需手动标记）

示例（源 Markdown 行）:

```markdown
[1] @黄帝@居=轩辕之丘=，娶於&西陵&之女。$天子$受命，%元年%始。
```

渲染器会把上行转换为相应的 `<span class="...">` 标签，由 `doc/shiji-styles.css` 控制视觉样式。

#### 对话引号的自动识别与样式

渲染器会自动识别对话中的引号内容，并应用特殊样式以提升可读性：

- **支持的引号类型**：
  - 中文双引号：""
  - 中文单引号：''
  - 日式单引号：「」
  - 日式双引号：『』

- **视觉效果**：
  - 引号内的文字显示为**斜体**
  - 背景添加**极淡的褐色底色**（透明度0.03）
  - 底部添加**褐色虚线**（透明度0.3），提供清晰的视觉边界
  - 引号内的实体标记（人名、地名等）仍然保持各自的样式
  - 设计理念：克制优雅，不干扰阅读，同时提供足够的视觉区分

- **示例**：
  ```markdown
  - @尧@曰："谁可顺此事？"
  - @放齐@曰："嗣子@丹硃@开明。"
  ```

  渲染为：
  ```html
  <li><span class="person">尧</span>曰：<span class="quoted">谁可顺此事？</span></li>
  <li><span class="person">放齐</span>曰：<span class="quoted">嗣子<span class="person">丹硃</span>开明。</span></li>
  ```

  CSS 样式（`.quoted`）：
  ```css
  .quoted {
      font-style: italic;
      background-color: rgba(139, 69, 19, 0.03);
      border-bottom: 1px dashed rgba(139, 69, 19, 0.3);
      padding: 0 2px;
  }
  ```

#### 推荐转换管道（工作流）

1. 保留原文与段落编号（遵守"忠实原则"）。
2. **实体识别与标注**：
   - **推荐方法**：使用大模型（如 Claude）的自然语言理解能力进行实体识别
   - **优势**：
     - 理解上下文语义，准确区分多义词（如"和"作为人名 vs 动词）
     - 识别复合实体（如"夏后帝启"、"西伯昌"）
     - 避免误标动词、成语、抽象概念等非实体用法
     - 处理边界情况（如"土既蚕"中的"蚕"是动词，不应标记）
   - **不推荐**：基于关键词列表的简单字符串匹配
     - 问题：无法理解上下文，容易误标或漏标
     - 例如：会错误地标记"蚕食"中的"蚕"，或漏掉上下文相关的人名
   - **工作流**：
     1. 大模型阅读完整章节，理解历史背景和人物关系
     2. 识别各类实体（人名、地名、官职、时间、朝代、制度、族群、器物、天文、神话、动植物）
     3. 根据上下文判断词性和语义，只标记名词性实体
     4. 生成带标记的 `*.tagged.md` 文件
     5. 人工审核和微调
3. 在 Markdown 层做轻量预处理：
   - 规范化段落编号（例如把 `[23.a]`、`[23a]` 规整为 `[23]`）。
   - 根据配置（如 `config/clans.json`）对已知氏族名做语义修正（可选择把它们转为 `&朝代&` 或在渲染阶段输出 `.clan`）。
   - **拆分对话段落**：将包含多个"X曰"的长段落拆分为独立的对话行（详见下文"对话拆分规则"）。
4. 用渲染器（`render_shiji_html.py`）将 token → HTML（生成 `<span class="...">`）并做基础 Markdown → HTML 转换（标题、列表、`[!NOTE] / [!NOTE tag]` → `.note-box`、引用合并等）。
5. 后处理（HTML 层）：合并相邻引用/注记片段、展平重复嵌套的 span、并对裸文本进行必要的语义包裹（仅显示层面，不改动原文字符）。

#### 段落长度控制

为提升可读性，应控制段落长度，避免超长段落：

**长度原则**：

1. **叙事段落**：单个段落不应超过150字符
2. **论述性内容**：谏言、策论、制度文献等可以较长，但应使用NOTE块标记
3. **拆分策略**：
   - 按语义单元拆分（事件、时间、人物转换点）
   - 使用子段落编号（如[67.1]、[67.2]）标识拆分后的段落
   - 保持每个子段落的语义完整性

#### 对话拆分规则

古文中的对话常以"X曰"标记说话人，为提升可读性，应将包含多个"X曰"的长段落拆分为独立的对话行。

**拆分原则**：

1. **识别对话标记**：查找"X曰："或"X曰："模式（X为人名、官职等）
2. **拆分位置**：在每个"X曰"之前拆分（第一个除外）
3. **保持完整性**：
   - 保留引号内容的完整性（不在引号中间拆分）
   - 保留段落编号在第一行
   - 非对话内容（如叙述）单独成行
4. **列表格式**：拆分后的每行都转换为列表项（`- `开头）

#### 论述性内容标记

对于长篇论述性内容（谏言、策论、制度、传说等），应使用NOTE块进行语义标记：

**标记类型**：

1. **`> [!NOTE 谏言]`**：大臣的谏言，从"X曰："后的引号开始，完整论述都在NOTE块内
2. **`> [!NOTE 策论]`**：纵横家的策略论述
3. **`> [!NOTE 制度]`**：制度性文献（如法律、礼制）
4. **`> [!NOTE 传说]`**：神话传说、轶事

**标记原则**：

1. **完整性**：论述从引号开始就应完整地放入NOTE块，不要切割
2. **语义连贯**：保持论述的完整语义单元
3. **结束标记**：使用`> [!ENDNOTE]`明确结束

**示例**：

```markdown
[25] @穆王@将征~犬戎~，@祭公谋父@谏曰：

> [!NOTE 谏言]
> "不可。先王燿德不观兵。夫兵戢而时动，动则威，观则玩，玩则无震。
>
> （完整的谏言内容...）"
> [!ENDNOTE]

王遂征之，得四白狼四白鹿以归。
```

**示例**：

原文（一行包含多个"曰"）：
```markdown
[1.1] 当帝尧之时，鸿水滔天，浩浩怀山襄陵，下民其忧。尧求能治水者，群臣四岳皆曰鲧可。尧曰："鲧为人负命毁族，不可。"四岳曰："等之未有贤於鲧者，原帝试之。"於是尧听四岳，用鲧治水。九年而水不息，功用不成。
```

拆分后（每个对话独立成行）：
```markdown
- [1.1] 当帝尧之时，鸿水滔天，浩浩怀山襄陵，下民其忧。尧求能治水者，群臣四岳皆曰鲧可。
- 尧曰："鲧为人负命毁族，不可。"
- 四岳曰："等之未有贤於鲧者，原帝试之。"
- 於是尧听四岳，用鲧治水。九年而水不息，功用不成。
```

**辅助工具**：

提供了对话拆分脚本 `tools/split_dialogues_v2.py` 作为辅助工具：

```bash
python3 tools/split_dialogues_v2.py chapter_md/002_夏本纪.md
```

**注意**：
- 脚本会自动识别包含多个"曰"的行并尝试拆分
- 拆分结果可能需要人工微调，特别是复杂的嵌套引号情况
- 建议先输出到临时文件检查，确认无误后再覆盖原文件

#### 工具与命令示例

- 从行内样式生成 token（生成 `*.tagged.md` 文件）：

```bash
python3 tools/convert_spans_to_simple.py chapter_md/001_五帝本纪.md
```

- 拆分对话段落：

```bash
python3 tools/split_dialogues_v2.py chapter_md/002_夏本纪.md chapter_md/002_夏本纪.split.md
```

- 批量生成所有章节的 HTML 和索引页面（推荐）：

```bash
python generate_all_chapters.py
```

- 单文件转换（仅在需要时使用）：

```bash
python render_shiji_html.py chapter_md/001_五帝本纪.tagged.md
```

#### 常见边界与建议策略

- **氏族 vs 人名**：
  - 方案 A（兼容）：渲染器后处理阶段把确认的氏族名替换为 `<span class="dynasty">...</span>`。
  - 方案 B（语义化）：新增 `.clan` 类并在渲染阶段输出 `<span class="clan">...</span>`；推荐把氏族名单放入 `config/clans.json`。

- **多义词处理**：
  - 对于常见字如"和"（既是人名也是动词"和谐"），不应自动标注，需要基于上下文手动标注。
  - 示例：`@羲@、@和@`（人名）vs `律和声`（动词，不标注）
  - 建议：在自动标注脚本中排除高频多义词，改为人工或大模型辅助标注。

- **动植物标记规则**：
  - **标记原则**：只标记作为名词的动植物实体，不标记动词或其他词性用法
  - **标记格式**：`🌿实体名🌿`（只包含具体的动植物名称，不包含类别词）
  - **正确示例**：
    - `🌿柳🌿` - 柳树
    - `🌿龙🌿` - 龙（神兽）
    - `🌿稻🌿` - 稻谷
    - `🌿马🌿` - 马
  - **错误示例**（避免）：
    - ❌ `🌿植物🌿柳🌿植物🌿` - 不要重复类别词
    - ❌ `🌿动物🌿龙🌿动物🌿` - 不要重复类别词
  - **不标记的情况**：
    - 动词用法：`土既蚕`（蚕作为动词"养蚕"）、`蚕食`（侵占）
    - 比喻用法：`龙飞凤舞`（成语）
    - 抽象概念：`龙颜`（指帝王容貌）
  - **边界情况**：
    - 复合词：`🌿桑🌿土既蚕` - 只标记桑树，蚕作为动词不标记
    - 并列：`🌿草🌿🌿木🌿渐包` - 草和木分别标记
    - 神兽：龙、凤、麒麟等神话动物也应标记

- **基于大模型的实体识别（推荐方法）**：
  - **核心原则**：使用大模型（如 Claude）的自然语言理解能力进行实体识别，而非基于关键词列表的简单字符串匹配
  - **为什么不用关键词匹配**：
    - 无法理解上下文语义
    - 无法区分多义词（如"和"作为人名 vs 动词"和谐"）
    - 无法识别复合实体（如"夏后帝启"、"西伯昌"）
    - 容易误标动词、成语、抽象概念
    - 例如：会错误标记"蚕食"中的"蚕"（动词），或"龙颜"中的"龙"（比喻）
  - **大模型的优势**：
    - 理解历史背景和人物关系
    - 准确判断词性和语义角色
    - 识别边界情况（如"土既蚕"中"蚕"是动词，不标记）
    - 处理复杂的语言现象（并列、省略、倒装等）
  - **工作流程**：
    1. 大模型阅读完整章节，建立语义理解
    2. 识别各类实体并判断是否应该标记
    3. 生成带标记的 `*.tagged.md` 文件
    4. 人工审核关键段落和边界情况
  - **质量保证**：
    - 对于重要章节，建议人工抽查标记质量
    - 特别关注多义词、动植物、复合人名等易错点
    - 保持标记的一致性（同一实体在全文中标记方式一致）

- **避免标签内匹配**：
  - 实体识别的正则表达式应排除 `<>` 字符，避免匹配已生成的 HTML 标签内容。
  - 示例：`=([^=<>]+)=` 而非 `=([^=]+)=`，防止匹配 `class="person"` 中的 `=`。

- **段落编号渲染**：
  - 渲染器会自动将 `[数字]` 或 `[数字.数字]` 格式的段落编号转换为带样式的 `<span class="para-num">` 标签。
  - 视觉效果：淡米色背景（`#FFF8E1`），深棕色文字（`#6D4C41`），字号比正文小（0.85em），圆角边框。
  - 段落编号会在渲染时自动去掉方括号，只保留数字部分。
  - 当段落编号独立成段时（如列表前的编号），会显示为块级元素，与后续内容保持适当间距。

- **标记处理顺序**：
  - `**` (加粗) 必须在 `*` (器物) 之前处理，避免冲突。
  - 段落编号在所有其他标记之后处理，避免与引号等标记冲突。
  - 渲染器中的 `ENTITY_PATTERNS` 列表顺序很重要。

- **段落编号规则**（圣经式编号）：
  - **保留原始编号**：原文中已有的段落编号（如 `[1]`、`[2]`、`[3]`）必须保持不变，不得重新编号。
  - **段落定义**：凡是做了回车（换行）的，就不算同一段。每个独立段落（被空行分隔）都应有编号。
  - **子段落编号**：
    - 当需要拆分一个已编号段落时，使用子编号格式：`[N.1]`、`[N.2]`、`[N.3]` 等
    - 更深层次的拆分使用：`[N.1.1]`、`[N.1.2]` 等
    - 例如：原段落 `[5]` 拆分后变为 `[5]`、`[5.1]`、`[5.2]`
  - **列表项编号**：
    - **长列表项**（包含对话、复杂内容）需要子编号，如 `[12.1]`、`[12.2]`
    - **短列表项**（简单的并列项，如方位、物品列举）不需要编号
    - 判断标准：如果列表项是完整的句子或对话，需要编号；如果只是简单词组，不需要编号
  - **编号位置**：段落编号应出现在每个段落或需要编号的列表项的开头。
  - **示例**：
    ```markdown
    [2]

    - 东至于=海=，登=丸山=，及=岱宗=。
    - 西至于=空桐=，登=鸡头=。
    - 南至于=江=，登=熊=、=湘=。
    - 北逐~荤粥~，合符=釜山=，而邑于=涿鹿之阿=。

    [3] 迁徙往来无常处，以师兵为营卫。

    [12]

    - [12.1] @尧@曰："谁可顺此事？"
    - [12.2] @放齐@曰："嗣子@丹硃@开明。"
    - [12.3] @尧@曰："吁！顽凶，不用。"
    ```

- **孤立 `>` 行**：渲染器把仅含 `>` 的行视为容器内空段落 `<p></p>`，以合并相邻引用/注记，避免出现字面 `>`。

- **`> [!NOTE]` / `> [!NOTE tag]` + `> [!ENDNOTE]`**：渲染为带语义类的 note 区块，例如

  ```html
  <div class="note-box note-warning">
    <h4>NOTE — warning</h4>
    <p>...</p>
  </div>
  ```

  渲染器同时允许在没有显式 `> [!ENDNOTE]` 的情况下根据上下文关闭 note（遇到非 `>` 行时结束），但推荐使用显式结束标记以避免语义模糊并支持嵌套/并列注记。

- **防止嵌套 span**：后处理应展平重复的同类 span（例如 `<span class="dynasty"><span class="dynasty">高辛</span></span>` → `<span class="dynasty">高辛</span>`）。

----

（附注）本节为工程化转换提供可复现规则；如需我把方案 B（新增 `.clan` 类并改写渲染器）一起提交，我可以在下一步实现并批量重渲染所有已转换章节。
