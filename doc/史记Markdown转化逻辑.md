# 《史记》语义化 Markdown 转化逻辑

本文档旨在详述将《史记》原始或改进后的文本（TXT）转化为具有语义结构的 Markdown 格式的准则。核心原则是**体现文本的内在逻辑关系**。

---

## 1. 层级结构 (Hierarchical Structure)

### 1.1 标题等级

- **一级标题 (`#`)**: 章节全名 (如 `# 五帝本纪`)。
- **二级标题 (`##`)**: 主体人物、时期或大的叙事单元 (如帝王名 `## 黄帝`)。
- **三级标题 (`###`)**: 核心人物下的具体维度，如“疆域治理”、“家世背景”、“轶事传说”等。

### 1.2 内容分隔

- 在重大的逻辑转换点（如从一位帝王切换到另一位帝王）使用水平分割线 (`---`)。

---

## 2. 并列结构 (Parallel Structure)

对于古代汉语中常见的列举性、并列性内容，应当采用 Markdown 列表以提升结构化水平：

- **血缘/世系**: 如列举子嗣及其封地。
- **官制/职责**: 明确各官员的职能。
- **地理/方位**: 如东南西北的具体疆域描述。
- **历法/节气**: 如羲和四子的季节职责。

**示例**:

> - 其一曰**玄嚣**，是为青阳；
> - 其二曰**昌意**，降居若水。

---

## 3. 语义化增强 (Semantic Enhancement)

利用特定的 Markdown 语法来区分不同性质的文本内容：

### 3.1 轶事与侧写

- 针对篇幅较长、具有故事性或独立性的片段（如“舜受磨难”），使用 **警告/注意框 (`> [!NOTE]`)** 进行视觉隔离，突出其叙事地位。

### 3.2 评价与总结

- **太史公曰**: 保留作为章节收尾的固定板块，使用 `## 太史公曰`。
- **赞 (Zan)**: 针对文末押韵的总结性文字，使用 **引用块 (`> `)** 格式，体现其文学性。

### 3.3 实体高亮与语义化标记（Token 约定与转换管道）

为了提升古文阅读体验并支持工程化处理，对不同类型的命名实体采用可机器识别且对人友好的短记号（token）进行标注；样式由集中 CSS 控制，内容与样式分离。

- 设计原则：
  - 最小侵入：保留原文字符，标注使用简短的包裹符号，便于人工阅读与编辑。
  - 语义明确：每种实体对应一个语义类别（CSS 类）以便统一渲染与检索。
  - 可配置：常见的氏族/部族名单应外置为配置文件以便维护与扩展。

#### Token 与 CSS 映射（常用）

- 人名: @人名@ → `.person`
- 地名: #地名# → `.place`
- 官职: $官职$ → `.official`
- 时间/纪年: %时间% → `.time`
- 朝代/氏族/国号: &朝代& → `.dynasty`（可选改为 `.clan`，详见下文）
- 制度/典章: ^制度^ → `.institution`
- 族群/部落: ~族群~ → `.tribe`
- 器物/礼器/书名（注意冲突）: *器物* → `.artifact`（若与 Markdown emphasis 冲突，优先使用转义或双星表示加粗）
- 天文/历法: !天文! → `.astronomy`
- 传说/神话: ?神话? → `.mythical`

示例（源 Markdown 行）:

```markdown
[1] @黄帝@居#轩辕之丘#，娶於&西陵&之女。$天子$受命，%元年%始。
```

渲染器会把上行转换为相应的 `<span class="...">` 标签，由 `doc/shiji-styles.css` 控制视觉样式。

#### 推荐转换管道（工作流）

1. 保留原文与段落编号（遵守“忠实原则”）。
2. 将原始文件中基于颜色或行内 `<span>` 的人工高亮，先用 `tools/convert_spans_to_simple.py` 转为短记号 token。
3. 在 Markdown 层做轻量预处理：
   - 规范化段落编号（例如把 `[23.a]`、`[23a]` 规整为 `[23]`）。
   - 根据配置（如 `config/clans.json`）对已知氏族名做语义修正（可选择把它们转为 `&朝代&` 或在渲染阶段输出 `.clan`）。
4. 用渲染器（`render_shiji_html.py`）将 token → HTML（生成 `<span class="...">`）并做基础 Markdown → HTML 转换（标题、列表、`[!NOTE]` → `.note-box`、引用合并等）。
5. 后处理（HTML 层）：合并相邻引用/注记片段、展平重复嵌套的 span、并对裸文本进行必要的语义包裹（仅显示层面，不改动原文字符）。

#### 工具与命令示例

- 从行内样式生成 token：

```bash
python3 tools/convert_spans_to_simple.py chapter_md/001_五帝本纪.md
```

- 将 token 的 Markdown 渲染为 HTML：

```bash
python3 render_shiji_html.py chapter_md/001_五帝本纪.simple.md
```

#### 常见边界与建议策略

- 氏族 vs 人名：
  - 方案 A（兼容）：渲染器后处理阶段把确认的氏族名替换为 `<span class="dynasty">...</span>`。
  - 方案 B（语义化）：新增 `.clan` 类并在渲染阶段输出 `<span class="clan">...</span>`；推荐把氏族名单放入 `config/clans.json`。
- 孤立 `>` 行：渲染器把仅含 `>` 的行视为容器内空段落 `<p></p>`，以合并相邻引用/注记，避免出现字面 `>`。
- `> [!NOTE]`：渲染为 `<div class="note-box"><h4>NOTE</h4>...</div>` 并收纳后续行直到 note 结束。
- 防止嵌套 span：后处理应展平重复的同类 span（例如 `<span class="dynasty"><span class="dynasty">高辛</span></span>` → `<span class="dynasty">高辛</span>`）。

----

（附注）本节为工程化转换提供可复现规则；如需我把方案 B（新增 `.clan` 类并改写渲染器）一起提交，我可以在下一步实现并批量重渲染所有已转换章节。
