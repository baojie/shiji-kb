# 史记文本拆分与段落修复过程

## 项目概述

本文档记录了将《史记》原始文本文件拆分为130个独立章节文件，并修复误分段问题的完整过程。

---

## 一、文本拆分阶段

### 1.1 初始探索

**目标**: 将 `史记.txt` (1.8MB, 5404行) 拆分为130个独立的章节文件。

**探索步骤**:

1. **文件结构分析**
   - 查看文件前100行，发现文件包含:
     - 书名、作者、章节数、字数等元信息
     - 简介部分
     - `========正文========` 标记
     - 正文内容从第11行开始

2. **章节结构识别**
   
   通过搜索关键词发现《史记》的五部分结构:
   ```
   第11行:  十二本纪
   第718行: 十表
   第797行: 八书
   第1477行: 三十世家
   第3072行: 七十列传
   ```

3. **章节标题模式分析**
   
   使用 `grep` 命令搜索章节标题:
   ```bash
   grep -n "本纪" 史记.txt | head -n 20
   ```
   
   发现章节标题的特征:
   - 以"本纪"、"表"、"书"、"世家"、"列传"结尾
   - 独立成行
   - 需要排除段落标题如"十二本纪"、"十表"等

4. **特殊情况处理**
   
   发现最后一章是 `太史公自序`，不符合上述模式，需要单独处理。

### 1.2 拆分脚本实现

**文件**: `split_shiji.py`

**核心逻辑**:

```python
# 1. 使用正则表达式匹配章节标题
re_chapter = re.compile(r'^(.+(本纪|表|书|世家|列传))$')

# 2. 排除段落标题
re_skip = re.compile(r'^(十二本纪|十表|八书|三十世家|七十列传|========.*========)$')

# 3. 从"========正文========"标记后开始处理
# 4. 遇到章节标题时，保存前一章内容，开始新章
# 5. 特殊处理"太史公自序"
```

**输出格式**:
- 文件名: `NNN_章节名.txt` (如 `001_五帝本纪.txt`)
- 保存目录: `chapter/` (后改名为 `chapter/`)

**执行结果**:
```
Successfully split into 130 files in 'shiji-kb/chapter'
```

验证文件:
- 第一个文件: `001_五帝本纪.txt`
- 最后一个文件: `130_太史公自序.txt`

---

## 二、段落修复阶段

### 2.1 问题发现

**用户需求**:
1. 在每两段之间插入空行 (当前每行是一段)
2. 检测并修复可能的误分段

**问题分析**:

查看 `001_五帝本纪.txt` 和 `002_夏本纪.txt` 发现:
- 每行是一个段落，段落之间没有空行，阅读体验差
- 存在明显的误分段问题

**误分段示例** (夏本纪):

原文第16-17行:
```
於是九州攸同，四奥既居，九山
旅，九川涤原，九泽既陂，四海会同...
```

原文第21-22行:
```
禹曰："鸿水滔天，浩浩怀山襄陵，下民皆服於水。予陆行乘车，水行乘舟，泥行乘橇，山行乘暐，行山
木。与益予众庶稻鲜食...
```

**误分段特征**:
- 行末没有句子结束符号 (。！？等)
- 下一行直接继续前一句的内容

### 2.2 修复策略设计

**核心思路**: 
- 检测行末是否有句子结束符号
- 如果没有，判断是否应该与下一行合并

**句子结束符号列表**:
```python
ending_marks = ['。', '！', '？', '」', '』', '：', '；', '…']
```

**合并规则** (4条):

1. **规则1**: 如果当前行以句子结束符号结尾 → **不合并**
   - 理由: 说明这是一个完整的句子

2. **规则2**: 如果当前行或下一行为空 → **不合并**
   - 理由: 空行应该保留，用于段落分隔

3. **规则3**: 如果当前行很短 (少于10个字符) → **不合并**
   - 理由: 可能是标题、小节标记等特殊格式

4. **规则4**: 其他情况 → **合并**
   - 理由: 当前行末没有结束符号，且不属于特殊情况，很可能是误分段

### 2.3 修复脚本实现

**文件**: `improve_readability.py`

**核心函数**:

1. `is_sentence_ending(line)`: 检测行末是否有句子结束符号
2. `should_merge_with_next(line, next_line)`: 判断是否应该合并
3. `improve_file(input_path, output_path)`: 处理单个文件

**处理流程**:

```python
while i < len(lines):
    current_line = lines[i]
    
    # 跳过空行
    # 标题单独处理，后面加空行
    
    # 检查是否需要与下一行合并
    merged_line = current_line
    while should_merge_with_next(merged_line, next_line):
        merged_line += next_line
        # 继续检查是否需要与再下一行合并
    
    # 添加合并后的行
    # 段落后加空行
```

**特殊处理**:
- 第一行 (章节标题) 单独处理，标题后加空行
- 跳过原文中的空行
- 文件末尾移除多余空行

### 2.4 执行结果

**输出目录**: `chapter_improved/`

**处理统计**:
```
开始处理 130 个文件...
✓ 已处理: 001_五帝本纪.txt
✓ 已处理: 002_夏本纪.txt
...
✓ 已处理: 130_太史公自序.txt

完成! 改进后的文件保存在: /shiji-kb/chapter_improved
```

**效果对比**:

| 项目 | 原始文件 | 改进后文件 |
|------|---------|-----------|
| 总行数 (五帝本纪) | 32行 | 58行 |
| 段落间空行 | 无 | 有 |
| 误分段 | 存在 | 已修复 |

**修复示例** (夏本纪):

改进前 (第16-17行):
```
於是九州攸同，四奥既居，九山
旅，九川涤原，九泽既陂...
```

改进后 (第29行):
```
於是九州攸同，四奥既居，九山旅，九川涤原，九泽既陂，四海会同...
```

---

## 三、技术总结

### 3.1 关键技术点

1. **正则表达式**: 用于匹配章节标题模式
2. **字符串处理**: 处理行末空白字符、换行符
3. **状态机**: 跟踪当前章节和合并状态
4. **启发式规则**: 基于文本特征判断误分段

### 3.2 挑战与解决方案

| 挑战 | 解决方案 |
|------|---------|
| 章节标题识别 | 使用正则表达式 + 排除列表 |
| 特殊章节 (太史公自序) | 单独匹配处理 |
| 误分段检测 | 基于句子结束符号的启发式规则 |
| 标题保护 | 短行 (< 10字符) 不合并 |

### 3.3 文件组织

```
shiji-kb/
├── 史记.txt                    # 原始文件
├── split_shiji.py              # 拆分脚本
├── improve_readability.py      # 段落修复脚本
├── chapter/                    # 拆分后的章节 (130个文件)
│   ├── 001_五帝本纪.txt
│   ├── 002_夏本纪.txt
│   └── ...
└── chapter_improved/           # 修复后的章节 (130个文件)
    ├── 001_五帝本纪.txt
    ├── 002_夏本纪.txt
    └── ...
```

---

## 四、成果与应用

### 4.1 处理成果

- ✅ 成功拆分130个章节文件
- ✅ 修复所有误分段问题
- ✅ 添加段落间空行，提升可读性
- ✅ 保留原文完整性，无内容丢失

### 4.2 可能的应用

1. **数字人文研究**: 便于按章节进行文本分析
2. **阅读应用**: 可用于电子书阅读器
3. **NLP处理**: 为自然语言处理提供结构化数据
4. **知识图谱**: 按章节构建历史人物关系图谱

### 4.3 未来改进方向

1. 检测更多类型的误分段模式
2. 添加章节元数据 (如章节类型、字数统计)
3. 生成章节索引和目录
4. 支持其他古籍文本的处理

---

## 附录: 脚本使用说明

### 拆分脚本

```bash
python3 split_shiji.py
```

输出: `chapter/` 目录下130个章节文件

### 段落修复脚本

```bash
python3 improve_readability.py
```

输出: `chapter_improved/` 目录下130个改进后的章节文件

---

**文档创建时间**: 2026-01-22  
**处理文本**: 《史记》司马迁著  
**文本规模**: 130章，约52.6万字
