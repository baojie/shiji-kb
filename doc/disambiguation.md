# 消歧方法：人名与年份

本文档说明史记知识库中人名消歧和年份消歧的技术方法。两者的核心设计原则相同：

- **不修改源文件**（`.tagged.md`），仅生成辅助元数据文件
- 渲染器读取元数据，在生成HTML时添加tooltip和正确链接
- 无法消歧的条目保持原样，不做错误猜测

## 一、人名消歧

**脚本**：`disambiguate_names.py`
**输出**：`disambiguation_map.json`

### 问题

标注文件中使用`@短名@`标记人名（如`@昭王@`），但同名者众多（秦昭王、楚昭王、燕昭王等）。
需要确定每个章节中的短名指代哪一位具体人物。

### 数据结构

```json
{
  "004": {"武王": "周武王", "成王": "周成王"},
  "005": {"昭王": "秦昭王", "惠王": "秦惠王"},
  ...
}
```

键为章节ID（3位数字），值为该章节的短名→全名映射。

### 启发式（按优先级）

1. **前缀国名**：`&秦&@昭王@` → 紧邻的朝代/国名标签提供明确线索 → `秦昭王`
2. **近距离国名**：80字符范围内出现的 `&state&` 或 `@StateX@` 标签
3. **章节主题国**：秦本纪(005) → 默认秦国人物，齐太公世家(032) → 默认齐国人物
4. **共现分析**：若同章节中出现了全名 `@秦昭王@`，则短名 `@昭王@` 归属同一人

### 渲染效果

- 显示文本保持原文（`昭王`），不改动源文件
- 链接指向消歧后的实体（`person.html#entity-秦昭王`）
- 添加tooltip显示全名（鼠标悬停可见）

---

## 二、年份消歧

**脚本**：`build_year_map.py`
**输出**：`reign_periods.json` + `year_ce_map.json`

### 问题

史记正文中的年份都是**在位纪年**（如`%三年%` = 某位君主的第三年），
没有绝对时间信息。需要：
1. 确定每个年份属于哪位君主
2. 换算为公元纪年

### 数据源：年表章节

项目中三个年表章节包含了完整的公元↔在位年映射：

| 年表 | 覆盖范围 | 格式特点 |
|------|----------|----------|
| 014 十二诸侯年表 | 841-478 BCE | 14列（周+13诸侯国），每行=1公元年 |
| 015 六国年表 | 476-207 BCE | 8列（周+秦+六国），每行=1公元年 |
| 022 将相年表 | 206-20 BCE | 纪年列含帝号+年号，每行=1公元年 |

"元年"条目标志新君即位，后续行递增。

### Phase 1：提取在位年表

从年表中解析出 `reign_periods.json`：

```json
{
  "rulers": {
    "秦孝公": {"state": "秦", "start_bce": 361, "end_bce": 338},
    "周宣王": {"state": "周", "start_bce": 827, "end_bce": 782},
    ...
  },
  "eras": {
    "建元": {"ruler": "孝武", "state": "汉", "start_bce": 140, "end_bce": 134},
    ...
  },
  "aliases": {"秦惠王": "秦惠文王", "高祖": "高皇帝", ...}
}
```

共提取351位君主、32个汉代年号。

公元换算公式：`bce_year = start_bce - year_num + 1`

### Phase 2：年份消歧

扫描所有 `*.tagged.md` 文件（排除年表章节自身），对每个 `%X年%` 实体：

#### 预过滤

跳过非历法年份：
- 时长/年龄：`立%十二年%卒`、`%十馀年%`
- 前文含"立"、"居"、"凡"、"共"、"在"等字

#### 消歧策略（按优先级）

1. **近距离君主**（nearby_ruler）：60字符范围内最近的 `@person@` 或 `$title$` 是已知君主
   - **优先本章节所属国**：如秦本纪中，优先匹配秦国君主，忽略叙事中提及的外国君主
   - **国名前缀推断**：如`宣公` → 在秦本纪中推断为`秦宣公`
   - 同时搜索 `@person@` 和 `$title$` 两种标注（世家章节常用 `$title$` 标注君主）
2. **序列延续**（sequential）：本段落前面已有已解析的年份 → 沿用同一君主
3. **小节标题**（section_ruler）：`## 秦王政时期` 标题含君主名 → 该节内年份归属该君主
   - 自动剥离常见后缀（时期、称王、继位、称霸等）
4. **年号直接映射**（era_name）：`%建元六年%` → 汉武帝建元六年 → 公元前135年
5. **近距离原始名**（raw_nearby）：找到人名但无法映射到已知君主 → 以"君主+年份"作为索引键

#### 结果校验

计算出的公元年份必须落在该君主已知在位范围内（容差5年），否则标记为仅有ruler_key。

### 数据结构

```json
{
  "005": {
    "7": {
      "元年": {"ce_year": -765, "ruler": "秦文公", "method": "nearby_ruler"}
    },
    "7.2": {
      "三年": {"ce_year": -763, "ruler": "秦文公", "method": "sequential"}
    }
  },
  "001": {
    "13.8": {
      "三年": {"ruler": "舜", "method": "raw_nearby", "ruler_key": "舜三年"}
    }
  }
}
```

键为 `chapter_id → para_id → 表面年份`。值包含：

- `ce_year`（负数=BCE）— 有公元年映射时
- `ruler_key`（如"舜三年"）— 无公元年映射时，用作索引键
- `ruler` 和 `method` — 始终存在

### Phase 3：编年索引页

`docs/entities/timeline.html` 包含两部分：

1. **公元纪年索引**：按世纪分组，每条显示：
   - 公元年份 + 所有并行在位君主的纪年别名（如"秦孝公元年、周显王八年"）
   - 所有引用该年份的章节段落链接

2. **先秦早期（年代不详）**：以"君主+年份"为索引的条目
   - 用于五帝、夏、殷、早周等年表未覆盖的年代

### 渲染效果

- 有公元年的年份实体悬停显示tooltip：`公元前763年（秦文公三年）`，点击跳转到 `timeline.html` 对应条目
- 仅有君主+年份的条目悬停显示如 `舜三年`，点击跳转到先秦早期对应条目
- 未映射的年份保持原有链接（指向 `time.html`）

---

## 管线集成

完整渲染管线顺序：

```
disambiguate_names.py  →  disambiguation_map.json
build_year_map.py      →  reign_periods.json + year_ce_map.json + timeline.html
generate_all_chapters.py  →  渲染所有章节HTML（读取上述元数据）
build_entity_index.py  →  实体索引页（含编年索引入口）
```

由 `generate_all_chapters.py` 统一调度。

## 统计

| 指标 | 人名消歧 | 年份消歧 |
|------|----------|----------|
| 数据源 | 全文扫描+人工规则 | 年表章节(014/015/022) |
| 覆盖范围 | 130篇全文 | 67篇（排除年表） |
| 映射数量 | ~3000条/章 | 1474条（502个公元年+242个君主纪年） |
| 未解决率 | 低 | ~8%（保守策略） |
