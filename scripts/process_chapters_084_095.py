#!/usr/bin/env python3
"""
æ‰¹é‡å¤„ç†ã€Šå²è®°ã€‹084-095ç« èŠ‚ï¼ˆåˆ—ä¼ ï¼‰
ä½¿ç”¨Claude APIè¿›è¡Œå®ä½“æ ‡æ³¨å’Œç»“æ„åŒ–å¤„ç†
"""

import anthropic
import os
import sys
from pathlib import Path


# ç« èŠ‚åˆ—è¡¨ 084-095
CHAPTERS = [
    "084_å±ˆåŸè´¾ç”Ÿåˆ—ä¼ ",
    "085_å•ä¸éŸ¦åˆ—ä¼ ",
    "086_åˆºå®¢åˆ—ä¼ ",
    "087_ææ–¯åˆ—ä¼ ",
    "088_è’™æ¬åˆ—ä¼ ",
    "089_å¼ è€³é™ˆé¦€åˆ—ä¼ ",
    "090_é­è±¹å½­è¶Šåˆ—ä¼ ",
    "091_é»¥å¸ƒåˆ—ä¼ ",
    "092_æ·®é˜´ä¾¯åˆ—ä¼ ",
    "093_éŸ©ä¿¡å¢ç»¾åˆ—ä¼ ",
    "094_ç”°å„‹åˆ—ä¼ ",
    "095_æ¨Šéƒ¦æ»•çŒåˆ—ä¼ ",
]


SYSTEM_PROMPT = """ä½ æ˜¯ã€Šå²è®°ã€‹ä¸“å®¶ï¼Œæ“…é•¿å¯¹å¤æ–‡è¿›è¡Œç»“æ„åŒ–æ ‡æ³¨å’Œå®ä½“è¯†åˆ«ã€‚

ä½ çš„ä»»åŠ¡æ˜¯å°†ã€Šå²è®°ã€‹åˆ—ä¼ åŸæ–‡å¤„ç†æˆç»“æ„åŒ–çš„Markdownæ ¼å¼ï¼Œå¹¶è¿›è¡Œå®ä½“æ ‡æ³¨ã€‚

## è¾“å‡ºæ ¼å¼è¦æ±‚

### 1. æ–‡æ¡£ç»“æ„
- **ä¸€çº§æ ‡é¢˜**ï¼š# [0] [åˆ—ä¼ å]
- **äºŒçº§æ ‡é¢˜**ï¼šæŒ‰äººç‰©å’Œäº‹ä»¶åˆ’åˆ†
  - å¯¹äºåˆä¼ ï¼ˆå¦‚"éŸ©ä¿¡å¢ç»¾åˆ—ä¼ "ï¼‰ï¼Œä¸ºæ¯ä¸ªä¸»è¦äººç‰©è®¾ç«‹äºŒçº§æ ‡é¢˜
  - åŒ…æ‹¬ï¼šå®¶ä¸–ã€æ—©å¹´ã€ä¸»è¦äº‹è¿¹ã€å¤ªå²å…¬æ›°ç­‰
- **ä¸‰çº§æ ‡é¢˜**ï¼šç»†åˆ†é‡è¦äº‹ä»¶
- **æ®µè½ç¼–å·**ï¼šä½¿ç”¨åœ£ç»å¼ç¼–å· [ç« .èŠ‚]ï¼ˆå¦‚ [1.1]ã€[1.2]ç­‰ï¼‰

### 2. å®ä½“æ ‡æ³¨è§„åˆ™ï¼ˆ11ç±»å®ä½“ï¼‰
- **äººå**: @äººå@ï¼ˆå¦‚ï¼š@å±ˆåŸ@ã€@è´¾è°Š@ã€@ææ–¯@ã€@éŸ©ä¿¡@ï¼‰
- **åœ°å**: =åœ°å=ï¼ˆå¦‚ï¼š=æ¥šå›½=ã€=å’¸é˜³=ã€=å…³ä¸­=ï¼‰
- **å®˜èŒ**: $å®˜èŒ$ï¼ˆå¦‚ï¼š$ä¸ç›¸$ã€$å¤ªå°‰$ã€$å¤§å°†å†›$ï¼‰
- **æ—¶é—´/çºªå¹´**: %æ—¶é—´%ï¼ˆå¦‚ï¼š%ç§¦å§‹çš‡äºŒåå…­å¹´%ã€%æ±‰é«˜ç¥–äº”å¹´%ï¼‰
- **æœä»£/æ°æ—/å›½å·**: &æœä»£&ï¼ˆå¦‚ï¼š&ç§¦&ã€&æ¥š&ã€&æ±‰&ï¼‰
- **åˆ¶åº¦/å…¸ç« **: ^åˆ¶åº¦^ï¼ˆå¦‚ï¼š^éƒ¡å¿åˆ¶^ã€^ä¸‰å…¬ä¹å¿^ï¼‰
- **æ—ç¾¤/éƒ¨è½**: ~æ—ç¾¤~ï¼ˆå¦‚ï¼š~åŒˆå¥´~ã€~æ¥šäºº~ï¼‰
- **å™¨ç‰©/ç¤¼å™¨**: *å™¨ç‰©*ï¼ˆå¦‚ï¼š*å‰‘*ã€*ç‰çº*ï¼‰
- **å¤©æ–‡/å†æ³•**: !å¤©æ–‡!ï¼ˆå¦‚ï¼š!å½—æ˜Ÿ!ã€!æ—¥é£Ÿ!ï¼‰
- **ä¼ è¯´/ç¥è¯**: ?ç¥è¯?ï¼ˆå¦‚ï¼š?å‡¤å‡°?ã€?é¾™?ï¼‰
- **åŠ¨æ¤ç‰©**: ğŸŒ¿åŠ¨æ¤ç‰©ğŸŒ¿ï¼ˆå¦‚ï¼šğŸŒ¿é©¬ğŸŒ¿ã€ğŸŒ¿å…°è‰ğŸŒ¿ï¼‰

### 3. åˆ—ä¼ ç‰¹æ®Šæ³¨æ„äº‹é¡¹
1. **äººç‰©å…³ç³»**ï¼šæ³¨æ„æ ‡æ³¨å¸ˆå¾’ã€æœ‹å‹ã€æ”¿æ²»å…³ç³»ï¼ˆå¦‚ï¼š@å¼ è€³@ä¸@é™ˆé¦€@ï¼‰
2. **å¯¹è¯å¤„ç†**ï¼šå¯¹è¯ä½¿ç”¨å¼•ç”¨å—ï¼ˆ> ç¬¦å·ï¼‰ï¼Œä¿æŒå¯¹è¯çš„ç‹¬ç«‹æ€§
3. **é•¿å¯¹è¯æ ‡æ³¨**ï¼šé•¿å¯¹è¯å‰å¯æ·»åŠ  NOTE è¯´æ˜ï¼ˆå¦‚ï¼š> NOTE: ææ–¯è°é€å®¢ä¹¦ï¼‰
4. **å†å²äº‹ä»¶**ï¼šé‡è¦äº‹ä»¶è®¾ä¸‰çº§æ ‡é¢˜ï¼ˆå¦‚ï¼š### è†è½²åˆºç§¦ç‹ï¼‰
5. **åˆä¼ å¤„ç†**ï¼šä¸€ä¸ªåˆ—ä¼ åŒ…å«å¤šäººæ—¶ï¼Œéœ€è¦æ¸…æ™°åˆ’åˆ†æ¯ä¸ªäººç‰©çš„éƒ¨åˆ†
6. **æ®µè½åˆ†æ®µ**ï¼šåˆç†åˆ†æ®µï¼Œä¿æŒå¯è¯»æ€§
7. **ä¿æŒåŸæ–‡**ï¼šä¸æ”¹å˜åŸæ–‡å†…å®¹ï¼Œåªæ·»åŠ ç»“æ„å’Œæ ‡æ³¨

### 4. è¾“å‡ºè¦æ±‚
- ç›´æ¥è¾“å‡ºå¤„ç†å¥½çš„Markdownæ–‡æœ¬
- ä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ€§æ–‡å­—
- ä¸è¦ä½¿ç”¨ä»£ç å—åŒ…è£¹è¾“å‡º
- ç¡®ä¿æ‰€æœ‰å®ä½“éƒ½è¢«æ­£ç¡®æ ‡æ³¨
- ä¿æŒåŸæ–‡çš„å®Œæ•´æ€§

## ç¤ºä¾‹æ ¼å¼

```markdown
# [0] å±ˆåŸè´¾ç”Ÿåˆ—ä¼ 

## å±ˆåŸ

### æ—©å¹´ä¸å¾—å¿—

[1.1] @å±ˆåŸ@å@å¹³@ï¼Œ&æ¥š&ä¹‹$åŒå§“$ä¹Ÿã€‚ä¸º&æ¥šæ€€ç‹$å·¦å¾’$ã€‚

[1.2] åšé—»å¼ºå¿—ï¼Œæ˜æ–¼æ²»ä¹±ï¼Œå¨´æ–¼è¾ä»¤ã€‚å…¥åˆ™ä¸$ç‹$å›¾è®®$å›½äº‹$ï¼Œä»¥å‡º$å·ä»¤$ï¼›å‡ºåˆ™æ¥é‡$å®¾å®¢$ï¼Œåº”å¯¹è¯¸ä¾¯ã€‚$ç‹$ç”šä»»ä¹‹ã€‚

### è¢«è°—å»èŒ

[2.1] %ä¸Šå®˜å¤§å¤«%ä¸ä¹‹åŒåˆ—ï¼Œäº‰å® è€Œå¿ƒå®³å…¶èƒ½ã€‚

[2.2] @æ€€ç‹@ä½¿@å±ˆåŸ@é€ ä¸º$å®ªä»¤$ï¼Œ@å±ˆåŸ@å±è‰ç¨¿æœªå®šã€‚

> NOTE: ä¸Šå®˜å¤§å¤«çš„è°—è¨€

[2.3] @ä¸Šå®˜å¤§å¤«@è§è€Œæ¬²å¤ºä¹‹ï¼Œ@å±ˆåŸ@ä¸ä¸ã€‚å› è°—ä¹‹æ›°ï¼š"$ç‹$ä½¿@å±ˆåŸ@ä¸º$ä»¤$ï¼Œä¼—è«ä¸çŸ¥ã€‚æ¯ä¸€ä»¤å‡ºï¼Œ@å¹³@ä¼å…¶åŠŸï¼Œä»¥ä¸º'éæˆ‘è«èƒ½ä¸º'ä¹Ÿã€‚"

[2.4] $ç‹$æ€’è€Œç–@å±ˆåŸ@ã€‚
```

è¯·æŒ‰ç…§ä»¥ä¸Šæ ¼å¼è¦æ±‚å¤„ç†ç»™å®šçš„åˆ—ä¼ æ–‡æœ¬ã€‚
"""


def process_chapter(client, chapter_num, chapter_name, input_text):
    """å¤„ç†å•ä¸ªç« èŠ‚"""

    user_prompt = f"""è¯·å¤„ç†ä»¥ä¸‹ã€Šå²è®°ã€‹åˆ—ä¼ ç« èŠ‚ï¼š{chapter_name}

åŸæ–‡å¦‚ä¸‹ï¼š

{input_text}

è¯·æŒ‰ç…§ç³»ç»Ÿæç¤ºä¸­çš„æ ¼å¼è¦æ±‚ï¼Œè¾“å‡ºç»“æ„åŒ–çš„Markdownæ–‡æœ¬ã€‚æ³¨æ„ï¼š
1. è¿™æ˜¯åˆ—ä¼ ï¼Œè®°å½•å†å²äººç‰©ä¼ è®°
2. æ³¨æ„æ ‡æ³¨äººç‰©é—´çš„å…³ç³»ï¼ˆå¸ˆå¾’ã€æœ‹å‹ã€æ”¿æ²»å…³ç³»ç­‰ï¼‰
3. æ³¨æ„æ ‡æ³¨å¯¹è¯å†…å®¹ä¸­çš„äººåã€åœ°åã€å®˜èŒç­‰å®ä½“
4. åˆç†åˆ’åˆ†æ®µè½å’Œç« èŠ‚
"""

    print(f"\n{'='*80}")
    print(f"æ­£åœ¨å¤„ç†: {chapter_num}_{chapter_name}")
    print(f"{'='*80}\n")

    try:
        response = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=16000,
            temperature=0,
            system=SYSTEM_PROMPT,
            messages=[
                {
                    "role": "user",
                    "content": user_prompt
                }
            ]
        )

        output_text = response.content[0].text

        # ç»Ÿè®¡ä¿¡æ¯
        lines = output_text.count('\n')
        entities_count = output_text.count('@') // 2  # äººå
        places_count = output_text.count('=') // 2   # åœ°å
        officials_count = output_text.count('$') // 2  # å®˜èŒ
        dynasties_count = output_text.count('&') // 2  # æœä»£

        print(f"âœ… å¤„ç†å®Œæˆ")
        print(f"   - è¡Œæ•°: {lines}")
        print(f"   - äººåæ ‡æ³¨: {entities_count}")
        print(f"   - åœ°åæ ‡æ³¨: {places_count}")
        print(f"   - å®˜èŒæ ‡æ³¨: {officials_count}")
        print(f"   - æœä»£æ ‡æ³¨: {dynasties_count}")
        print(f"   - Tokenä½¿ç”¨: {response.usage.input_tokens} in / {response.usage.output_tokens} out")

        return output_text, True

    except Exception as e:
        print(f"âŒ å¤„ç†å¤±è´¥: {str(e)}")
        return None, False


def main():
    # æ£€æŸ¥APIå¯†é’¥
    api_key = os.environ.get("ANTHROPIC_API_KEY")
    if not api_key:
        print("âŒ é”™è¯¯: æœªè®¾ç½® ANTHROPIC_API_KEY ç¯å¢ƒå˜é‡")
        return 1

    client = anthropic.Anthropic(api_key=api_key)

    base_dir = Path("/home/baojie/work/shiji-kb")
    input_dir = base_dir / "docs" / "original_text"
    output_dir = base_dir / "chapter_md"

    # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
    output_dir.mkdir(parents=True, exist_ok=True)

    print("="*80)
    print("ã€Šå²è®°ã€‹æ‰¹é‡å¤„ç†å·¥å…· - ç« èŠ‚ 084-095ï¼ˆåˆ—ä¼ ï¼‰")
    print("="*80)
    print(f"è¾“å…¥ç›®å½•: {input_dir}")
    print(f"è¾“å‡ºç›®å½•: {output_dir}")
    print(f"ç« èŠ‚æ•°é‡: {len(CHAPTERS)}")
    print("="*80)

    success_count = 0
    failed_chapters = []

    for chapter in CHAPTERS:
        chapter_num = chapter.split('_')[0]
        chapter_name = chapter.split('_')[1]

        input_file = input_dir / f"{chapter}.txt"
        output_file = output_dir / f"{chapter}.tagged.md"

        # æ£€æŸ¥è¾“å…¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not input_file.exists():
            print(f"âš ï¸  è·³è¿‡: {chapter} (æ–‡ä»¶ä¸å­˜åœ¨)")
            failed_chapters.append((chapter, "æ–‡ä»¶ä¸å­˜åœ¨"))
            continue

        # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼ˆä¸è¯¢é—®ï¼Œç›´æ¥å¤„ç†ï¼‰
        if output_file.exists():
            print(f"âš ï¸  æ–‡ä»¶å·²å­˜åœ¨ï¼Œå°†è¦†ç›–: {output_file.name}")

        # è¯»å–åŸæ–‡
        with open(input_file, 'r', encoding='utf-8') as f:
            input_text = f.read()

        # å¤„ç†ç« èŠ‚
        output_text, success = process_chapter(client, chapter_num, chapter_name, input_text)

        if success and output_text:
            # ä¿å­˜ç»“æœ
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(output_text)
            print(f"ğŸ’¾ å·²ä¿å­˜: {output_file.name}\n")
            success_count += 1
        else:
            failed_chapters.append((chapter, "å¤„ç†å¤±è´¥"))

    # è¾“å‡ºç»Ÿè®¡
    print("\n" + "="*80)
    print("å¤„ç†å®Œæˆç»Ÿè®¡")
    print("="*80)
    print(f"âœ… æˆåŠŸ: {success_count}/{len(CHAPTERS)}")

    if failed_chapters:
        print(f"âŒ å¤±è´¥: {len(failed_chapters)}")
        for chapter, reason in failed_chapters:
            print(f"   - {chapter}: {reason}")

    return 0 if len(failed_chapters) == 0 else 1


if __name__ == '__main__':
    sys.exit(main())
